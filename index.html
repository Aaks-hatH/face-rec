<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Face Recognition System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #f5f5f5;
            --bg-secondary: white;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #ddd;
            --success: #4CAF50;
            --danger: #f44336;
            --warning: #FF9800;
            --info: #2196F3;
        }
        
        body.dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #444;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            transition: all 0.3s;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .header h1 { 
            font-size: 2em; 
            color: var(--text-primary);
            margin-bottom: 10px;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            overflow-x: auto;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .tab.active {
            background: var(--info);
            color: white;
            border-color: var(--info);
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .btn {
            padding: 12px 24px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.2s;
        }
        
        .btn:hover:not(:disabled) { 
            background: #f0f0f0;
            transform: scale(1.02); 
        }
        .btn:active:not(:disabled) { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--info); color: white; border-color: var(--info); }
        .btn-success { background: var(--success); color: white; border-color: var(--success); }
        .btn-danger { background: var(--danger); color: white; border-color: var(--danger); }
        .btn-warning { background: var(--warning); color: white; border-color: var(--warning); }
        
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); 
            gap: 20px; 
            margin-bottom: 20px; 
        }
        
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 20px;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            background: #000;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            min-height: 300px;
        }
        
        video, canvas { width: 100%; display: block; }
        canvas { position: absolute; top: 0; left: 0; }
        
        .controls { display: flex; flex-direction: column; gap: 12px; }
        
        input, select, textarea {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--info);
        }
        
        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--border-color);
            outline: none;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 4px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--info);
        }
        
        .stat-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 8px;
        }
        
        .face-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .face-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .face-item img {
            width: 60px;
            height: 60px;
            border: 1px solid var(--border-color);
            object-fit: cover;
            border-radius: 4px;
        }
        
        .face-info { flex: 1; }
        
        .face-name {
            font-weight: bold;
            color: var(--text-primary);
        }
        
        .face-time {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }
        
        .badge-success { background: var(--success); color: white; }
        .badge-danger { background: var(--danger); color: white; }
        .badge-info { background: var(--info); color: white; }
        .badge-warning { background: var(--warning); color: white; }
        
        .log-entry {
            padding: 12px;
            border-left: 3px solid var(--info);
            background: var(--bg-primary);
            margin-bottom: 8px;
            border-radius: 0 4px 4px 0;
        }
        
        .log-time {
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        
        .message {
            padding: 12px;
            border-radius: 4px;
            margin-top: 12px;
            text-align: center;
            display: none;
            border: 1px solid var(--border-color);
        }
        
        .message.show { display: block; }
        
        .live-count {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 15px;
        }
        
        .snapshot-item {
            position: relative;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .snapshot-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .snapshot-info {
            padding: 8px;
            background: var(--bg-secondary);
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .chart-bar {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        
        .chart-label {
            width: 100px;
            font-size: 14px;
            color: var(--text-primary);
        }
        
        .chart-bar-fill {
            height: 25px;
            background: var(--info);
            border-radius: 4px;
            transition: width 0.3s;
        }
        
        .chart-value {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-primary);
        }
        
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Ultimate Face Recognition System</h1>
            <p style="color: var(--text-secondary);">Made By Aakshat Hariharan</p>
            <div class="header-controls">
                <button class="btn" onclick="toggleDarkMode()" id="darkModeBtn">Dark Mode</button>
                <button class="btn btn-warning" onclick="toggleVoice()" id="voiceBtn">Voice: OFF</button>
            </div>
            <div style="display:flex;gap:10px;justify-content:center;margin-top:15px;flex-wrap:wrap;">
                <a href="regular.html" class="btn" style="text-decoration:none;">Regular Version</a>
                <a href="deepfake.html" class="btn" style="text-decoration:none;">Deepfake Detection</a>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('register')">Register</div>
            <div class="tab" onclick="switchTab('recognize')">Recognize</div>
            <div class="tab" onclick="switchTab('attendance')">Attendance</div>
            <div class="tab" onclick="switchTab('analytics')">Analytics</div>
            <div class="tab" onclick="switchTab('history')">History</div>
            <div class="tab" onclick="switchTab('compare')">Compare</div>
            <div class="tab" onclick="switchTab('settings')">Settings</div>
        </div>

        <!-- REGISTER TAB -->
        <div id="register" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h3 style="margin-bottom: 15px;">Camera</h3>
                    <div class="video-container">
                        <video id="videoReg" autoplay muted playsinline></video>
                        <canvas id="overlayReg"></canvas>
                        <div class="live-count" id="liveCountReg">Faces: 0</div>
                    </div>
                    <canvas id="canvasReg" style="display:none;"></canvas>

                    <div class="controls">
                        <select id="cameraSelect">
                            <option value="">Select Camera</option>
                        </select>
                        <button class="btn btn-primary" id="startCamReg">Start Camera</button>
                        <input type="text" id="nameInput" placeholder="Enter name...">
                        <div style="display:flex;gap:10px;">
                            <button class="btn btn-success" id="captureBtn" style="flex:1;">Capture</button>
                            <button class="btn" id="uploadBtn" style="flex:1;">Upload Photo</button>
                        </div>
                        <button class="btn btn-info" id="batchRegisterBtn">Batch Register (Multiple)</button>
                        <input type="file" id="fileInput" accept="image/*" style="display:none;">
                        <input type="file" id="batchFileInput" accept="image/*" multiple style="display:none;">
                    </div>
                    <div class="message" id="msgReg"></div>
                </div>

                <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                        <h3>Registered Faces</h3>
                        <span class="badge badge-info" id="faceCount">0</span>
                    </div>
                    <div class="search-box">
                        <input type="search" id="searchInput" placeholder="Search faces...">
                    </div>
                    <div style="display:flex;gap:8px;margin-bottom:15px;">
                        <button class="btn btn-info" onclick="exportData()" style="flex:1;">Export</button>
                        <button class="btn btn-warning" onclick="importData()" style="flex:1;">Import</button>
                        <button class="btn btn-danger" onclick="clearAll()" style="flex:1;">Clear All</button>
                    </div>
                    <input type="file" id="importInput" accept=".json" style="display:none;">
                    <div class="face-list" id="faceList"></div>
                </div>
            </div>
        </div>

        <!-- RECOGNIZE TAB -->
        <div id="recognize" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h3 style="margin-bottom: 15px;">Live Recognition</h3>
                    <div class="video-container">
                        <video id="videoRec" autoplay muted playsinline></video>
                        <canvas id="overlayRec"></canvas>
                        <div class="live-count" id="liveCountRec">Faces: 0</div>
                    </div>

                    <div class="controls">
                        <button class="btn btn-primary" id="startCamRec">Start Recognition</button>
                        <button class="btn btn-success" id="captureSnapshot">Capture Snapshot</button>
                        <label style="display:flex;align-items:center;gap:8px;">
                            <input type="checkbox" id="blurUnknown"> Blur Unknown Faces
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;">
                            <input type="checkbox" id="alertUnknown"> Alert on Unknown Face
                        </label>
                    </div>
                    <div class="message" id="msgRec"></div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 15px;">Captured Snapshots</h3>
                    <button class="btn btn-danger" onclick="clearSnapshots()" style="width:100%;margin-bottom:15px;">Clear All Snapshots</button>
                    <div id="snapshotGallery" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;max-height:400px;overflow-y:auto;"></div>
                </div>
            </div>
        </div>

        <!-- ATTENDANCE TAB -->
        <div id="attendance" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="todayCount">0</div>
                    <div class="stat-label">Today's Visits</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="uniqueToday">0</div>
                    <div class="stat-label">Unique Visitors</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalRecognitions">0</div>
                    <div class="stat-label">Total Recognitions</div>
                </div>
            </div>

            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                    <h3>Attendance Log</h3>
                    <button class="btn btn-info" onclick="exportAttendance()">Export CSV</button>
                </div>
                <div style="max-height:500px;overflow-y:auto;" id="attendanceLog"></div>
            </div>
        </div>

        <!-- ANALYTICS TAB -->
        <div id="analytics" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="avgConfidence">0%</div>
                    <div class="stat-label">Average Confidence</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="mostFrequent">-</div>
                    <div class="stat-label">Most Frequent</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalDetections">0</div>
                    <div class="stat-label">Total Detections</div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom:15px;">Top 5 Most Recognized</h3>
                <div id="topRecognized"></div>
            </div>
        </div>

        <!-- HISTORY TAB -->
        <div id="history" class="tab-content">
            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                    <h3>Recognition History</h3>
                    <button class="btn btn-danger" onclick="clearHistory()">Clear History</button>
                </div>
                <div style="max-height:600px;overflow-y:auto;" id="historyLog"></div>
            </div>
        </div>

        <!-- COMPARE TAB -->
        <div id="compare" class="tab-content">
            <div class="card">
                <h3 style="margin-bottom:15px;">Face Comparison Tool</h3>
                <p style="color:var(--text-secondary);margin-bottom:20px;">Upload two photos to compare facial similarity</p>
                <div class="grid">
                    <div>
                        <h4 style="margin-bottom:10px;">Face 1</h4>
                        <input type="file" id="compare1" accept="image/*" style="margin-bottom:10px;">
                        <div id="preview1" style="width:100%;height:250px;background:var(--bg-primary);border:2px dashed var(--border-color);border-radius:4px;display:flex;align-items:center;justify-content:center;overflow:hidden;">
                            <span style="color:var(--text-secondary);">No image selected</span>
                        </div>
                    </div>
                    <div>
                        <h4 style="margin-bottom:10px;">Face 2</h4>
                        <input type="file" id="compare2" accept="image/*" style="margin-bottom:10px;">
                        <div id="preview2" style="width:100%;height:250px;background:var(--bg-primary);border:2px dashed var(--border-color);border-radius:4px;display:flex;align-items:center;justify-content:center;overflow:hidden;">
                            <span style="color:var(--text-secondary);">No image selected</span>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="compareFaces()" style="width:100%;margin-top:15px;">Compare Faces</button>
                <div id="compareResult" style="margin-top:20px;"></div>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="settings" class="tab-content">
            <div class="card">
                <h3 style="margin-bottom:20px;">Recognition Settings</h3>
                
                <div class="slider-container">
                    <label><strong>Confidence Threshold:</strong> <span id="thresholdValue">60%</span></label>
                    <p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">Higher values require more accurate matches</p>
                    <input type="range" id="thresholdSlider" class="slider" min="30" max="90" value="60">
                </div>

                <div class="slider-container">
                    <label><strong>Detection Speed:</strong> <span id="speedValue">Medium (200ms)</span></label>
                    <p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">Lower values = faster detection (uses more CPU)</p>
                    <input type="range" id="speedSlider" class="slider" min="100" max="1000" value="200" step="100">
                </div>

                <div style="border-top:1px solid var(--border-color);padding-top:20px;margin-top:20px;">
                    <h4 style="margin-bottom:15px;">Alert Settings</h4>
                    <label style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                        <input type="checkbox" id="alertSpecific"> Alert for Specific People
                    </label>
                    <select id="alertPerson" style="width:100%;" disabled>
                        <option value="">Select person to alert</option>
                    </select>
                </div>

                <div style="border-top:1px solid var(--border-color);padding-top:20px;margin-top:20px;">
                    <h4 style="margin-bottom:15px;">Data Management</h4>
                    <button class="btn btn-warning" onclick="backupData()" style="width:100%;margin-bottom:10px;">Backup All Data</button>
                    <button class="btn btn-info" onclick="restoreData()" style="width:100%;">Restore Data</button>
                    <input type="file" id="restoreInput" accept=".json" style="display:none;">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
    <script>
        // Global variables
        let cameraStream = null;
        let registeredFaces = [];
        let aiModelsReady = false;
        let currentTab = 'register';
        let isDetecting = false;
        let recognitionHistory = [];
        let attendanceLog = [];
        let snapshots = [];
        let voiceEnabled = false;
        let confidenceThreshold = 0.6;
        let detectionSpeed = 200;
        let compareImage1 = null;
        let compareImage2 = null;
        let alertSpecificPerson = '';
        let lastRecognized = {};

        // Initialize
        async function init() {
            await loadModels();
            await loadCameras();
            loadStoredData();
            updateUI();
            setupEventListeners();
        }

        // Load AI models
        async function loadModels() {
            const modelUrl = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
            try {
                showMessage('msgReg', 'Loading AI models...', 'info');
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(modelUrl),
                    faceapi.nets.faceLandmark68Net.loadFromUri(modelUrl),
                    faceapi.nets.faceRecognitionNet.loadFromUri(modelUrl)
                ]);
                aiModelsReady = true;
                showMessage('msgReg', 'Models loaded successfully!', 'success');
                setTimeout(() => document.getElementById('msgReg').classList.remove('show'), 2000);
            } catch (error) {
                showMessage('msgReg', 'Failed to load AI models', 'error');
                console.error(error);
            }
        }

        // Load available cameras
        async function loadCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cameras = devices.filter(d => d.kind === 'videoinput');
                const select = document.getElementById('cameraSelect');
                cameras.forEach((cam, i) => {
                    const opt = document.createElement('option');
                    opt.value = cam.deviceId;
                    opt.textContent = cam.label || `Camera ${i + 1}`;
                    select.appendChild(opt);
                });
                if (cameras.length > 0) select.value = cameras[0].deviceId;
            } catch (error) {
                console.error('Camera enumeration failed:', error);
            }
        }

        // Load stored data
        function loadStoredData() {
            try {
                registeredFaces = JSON.parse(localStorage.getItem('faces') || '[]');
                recognitionHistory = JSON.parse(localStorage.getItem('history') || '[]');
                attendanceLog = JSON.parse(localStorage.getItem('attendance') || '[]');
                snapshots = JSON.parse(localStorage.getItem('snapshots') || '[]');
            } catch (error) {
                console.error('Failed to load data:', error);
            }
        }

        // Save data
        function saveData() {
            try {
                localStorage.setItem('faces', JSON.stringify(registeredFaces));
                localStorage.setItem('history', JSON.stringify(recognitionHistory));
                localStorage.setItem('attendance', JSON.stringify(attendanceLog));
                localStorage.setItem('snapshots', JSON.stringify(snapshots));
            } catch (error) {
                console.error('Failed to save data:', error);
            }
        }

        // Update all UI elements
        function updateUI() {
            updateFaceList();
            updateAttendance();
            updateHistory();
            updateAnalytics();
            updateSnapshotGallery();
            updateAlertPersonList();
        }

        // Update face list
        function updateFaceList() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = registeredFaces.filter(f => f.name.toLowerCase().includes(searchTerm));
            
            document.getElementById('faceCount').textContent = registeredFaces.length;
            
            const list = document.getElementById('faceList');
            if (filtered.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:20px;">No faces found</p>';
                return;
            }
            
            list.innerHTML = filtered.map(face => `
                <div class="face-item">
                    <img src="${face.image}" alt="${face.name}">
                    <div class="face-info">
                        <div class="face-name">${face.name}</div>
                        <div class="face-time">${face.time}</div>
                    </div>
                    <button class="btn btn-danger" onclick="deleteFace(${face.id})" style="padding:8px 12px;">Delete</button>
                </div>
            `).join('');
        }

        // Update attendance
        function updateAttendance() {
            const today = new Date().toLocaleDateString();
            const todayLogs = attendanceLog.filter(log => log.date === today);
            const uniqueNames = [...new Set(todayLogs.map(log => log.name))];
            
            document.getElementById('todayCount').textContent = todayLogs.length;
            document.getElementById('uniqueToday').textContent = uniqueNames.length;
            document.getElementById('totalRecognitions').textContent = attendanceLog.length;
            
            const logDiv = document.getElementById('attendanceLog');
            if (attendanceLog.length === 0) {
                logDiv.innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:20px;">No attendance records</p>';
                return;
            }
            
            logDiv.innerHTML = attendanceLog.slice().reverse().map(log => `
                <div class="log-entry">
                    <strong>${log.name}</strong> - ${log.confidence}% confidence
                    <div class="log-time">${log.timestamp}</div>
                </div>
            `).join('');
        }

        // Update history
        function updateHistory() {
            const logDiv = document.getElementById('historyLog');
            if (recognitionHistory.length === 0) {
                logDiv.innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:20px;">No recognition history</p>';
                return;
            }
            
            logDiv.innerHTML = recognitionHistory.slice().reverse().map(log => `
                <div class="log-entry" style="border-left-color:${log.isUnknown ? 'var(--danger)' : 'var(--success)'}">
                    <strong>${log.name}</strong>${log.isUnknown ? '' : ' - ' + log.confidence + '% confidence'}
                    <div class="log-time">${log.timestamp}</div>
                </div>
            `).join('');
        }

        // Update analytics
        function updateAnalytics() {
            if (recognitionHistory.length === 0) {
                document.getElementById('avgConfidence').textContent = '0%';
                document.getElementById('mostFrequent').textContent = '-';
                document.getElementById('totalDetections').textContent = '0';
                document.getElementById('topRecognized').innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:20px;">No data available</p>';
                return;
            }
            
            // Calculate average confidence
            const recognized = recognitionHistory.filter(h => !h.isUnknown);
            const avgConf = recognized.length > 0 
                ? Math.round(recognized.reduce((sum, h) => sum + h.confidence, 0) / recognized.length)
                : 0;
            document.getElementById('avgConfidence').textContent = avgConf + '%';
            
            // Find most frequent
            const nameCounts = {};
            recognized.forEach(h => {
                nameCounts[h.name] = (nameCounts[h.name] || 0) + 1;
            });
            const sortedNames = Object.entries(nameCounts).sort((a, b) => b[1] - a[1]);
            document.getElementById('mostFrequent').textContent = sortedNames.length > 0 ? sortedNames[0][0] : '-';
            document.getElementById('totalDetections').textContent = recognitionHistory.length;
            
            // Top 5 chart
            const top5 = sortedNames.slice(0, 5);
            const maxCount = top5.length > 0 ? top5[0][1] : 1;
            document.getElementById('topRecognized').innerHTML = top5.length > 0 ? top5.map(([name, count]) => `
                <div class="chart-bar">
                    <div class="chart-label">${name}</div>
                    <div class="chart-bar-fill" style="width:${(count / maxCount) * 60}%;"></div>
                    <div class="chart-value">${count}</div>
                </div>
            `).join('') : '<p style="text-align:center;color:var(--text-secondary);padding:20px;">No data available</p>';
        }

        // Update snapshot gallery
        function updateSnapshotGallery() {
            const gallery = document.getElementById('snapshotGallery');
            if (snapshots.length === 0) {
                gallery.innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:20px;grid-column:1/-1;">No snapshots captured</p>';
                return;
            }
            
            gallery.innerHTML = snapshots.map((snap, i) => `
                <div class="snapshot-item">
                    <img src="${snap.image}" alt="Snapshot ${i + 1}">
                    <div class="snapshot-info">
                        ${snap.timestamp}
                        <button onclick="deleteSnapshot(${i})" style="float:right;background:var(--danger);color:white;border:none;padding:2px 6px;border-radius:3px;cursor:pointer;">Ã—</button>
                    </div>
                </div>
            `).join('');
        }

        // Update alert person list
        function updateAlertPersonList() {
            const select = document.getElementById('alertPerson');
            select.innerHTML = '<option value="">Select person to alert</option>' +
                registeredFaces.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
        }

        // Switch tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const tabs = ['register', 'recognize', 'attendance', 'analytics', 'history', 'compare', 'settings'];
            document.querySelectorAll('.tab')[tabs.indexOf(tabName)].classList.add('active');
            document.getElementById(tabName).classList.add('active');
            currentTab = tabName;
            
            if (tabName === 'analytics') updateAnalytics();
            if (tabName === 'attendance') updateAttendance();
            if (tabName === 'history') updateHistory();
        }

        // Toggle dark mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const btn = document.getElementById('darkModeBtn');
            btn.textContent = document.body.classList.contains('dark-mode') ? 'Light Mode' : 'Dark Mode';
        }

        // Toggle voice
        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            document.getElementById('voiceBtn').textContent = voiceEnabled ? 'Voice: ON' : 'Voice: OFF';
        }

        // Speak name
        function speak(text) {
            if (!voiceEnabled || !window.speechSynthesis) return;
            const utterance = new SpeechSynthesisUtterance(text);
            speechSynthesis.speak(utterance);
        }

        // Show message
        function showMessage(id, text, type) {
            const msg = document.getElementById(id);
            msg.textContent = text;
            msg.className = 'message show';
            msg.style.background = type === 'success' ? '#dff0d8' : type === 'error' ? '#f2dede' : '#d9edf7';
            msg.style.color = type === 'success' ? '#3c763d' : type === 'error' ? '#a94442' : '#31708f';
        }

        // Start camera
        async function startCamera(videoId, mode) {
            const video = document.getElementById(videoId);
            const btn = document.getElementById(mode === 'register' ? 'startCamReg' : 'startCamRec');
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(t => t.stop());
                cameraStream = null;
                video.srcObject = null;
                btn.textContent = mode === 'register' ? 'Start Camera' : 'Start Recognition';
                btn.className = 'btn btn-primary';
                isDetecting = false;
                const overlay = document.getElementById(mode === 'register' ? 'overlayReg' : 'overlayRec');
                overlay.getContext('2d').clearRect(0, 0, overlay.width, overlay.height);
                return;
            }

            if (!aiModelsReady) {
                showMessage(mode === 'register' ? 'msgReg' : 'msgRec', 'AI models still loading...', 'error');
                return;
            }

            const deviceId = document.getElementById('cameraSelect').value;
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { deviceId: deviceId || undefined, width: 640, height: 480 }
                });
                video.srcObject = cameraStream;
                await new Promise(resolve => video.onloadedmetadata = resolve);
                
                const overlay = document.getElementById(mode === 'register' ? 'overlayReg' : 'overlayRec');
                overlay.width = video.videoWidth;
                overlay.height = video.videoHeight;
                
                btn.textContent = 'Stop Camera';
                btn.className = 'btn btn-danger';
                showMessage(mode === 'register' ? 'msgReg' : 'msgRec', 'Camera started', 'success');
                
                if (mode === 'recognize') {
                    isDetecting = true;
                    detectFaces(video, overlay);
                }
            } catch (error) {
                showMessage(mode === 'register' ? 'msgReg' : 'msgRec', 'Camera error: ' + error.message, 'error');
            }
        }

        // Detect faces continuously
        let lastDetection = 0;
        async function detectFaces(video, canvas) {
            if (!isDetecting || !cameraStream) return;

            const now = Date.now();
            if (now - lastDetection < detectionSpeed) {
                requestAnimationFrame(() => detectFaces(video, canvas));
                return;
            }
            lastDetection = now;

            try {
                const detections = await faceapi
                    .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptors();

                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                document.getElementById('liveCountRec').textContent = `Faces: ${detections.length}`;

                if (detections.length > 0 && registeredFaces.length > 0) {
                    const matcher = new faceapi.FaceMatcher(
                        registeredFaces.map(f => new faceapi.LabeledFaceDescriptors(
                            f.name,
                            [new Float32Array(f.descriptor)]
                        )),
                        confidenceThreshold
                    );

                    detections.forEach(detection => {
                        const match = matcher.findBestMatch(detection.descriptor);
                        const box = detection.detection.box;
                        const isUnknown = match.label === 'unknown';
                        
                        // Blur if enabled
                        if (isUnknown && document.getElementById('blurUnknown').checked) {
                            ctx.filter = 'blur(20px)';
                            ctx.drawImage(video, box.x, box.y, box.width, box.height, box.x, box.y, box.width, box.height);
                            ctx.filter = 'none';
                        }
                        
                        ctx.strokeStyle = isUnknown ? '#f44336' : '#4CAF50';
                        ctx.lineWidth = 3;
                        ctx.strokeRect(box.x, box.y, box.width, box.height);
                        
                        ctx.fillStyle = isUnknown ? '#f44336' : '#4CAF50';
                        ctx.fillRect(box.x, box.y - 30, box.width, 30);
                        
                        ctx.fillStyle = 'white';
                        ctx.font = 'bold 16px Arial';
                        const label = isUnknown ? 'Unknown' : `${match.label} (${Math.round((1 - match.distance) * 100)}%)`;
                        ctx.fillText(label, box.x + 5, box.y - 10);
                        
                        // Log recognition
                        const confidence = Math.round((1 - match.distance) * 100);
                        logRecognition(match.label, confidence, isUnknown);
                        
                        // Voice announcement
                        if (!isUnknown && !lastRecognized[match.label]) {
                            speak(`Hello ${match.label}`);
                            lastRecognized[match.label] = Date.now();
                        }
                        
                        // Reset last recognized after 5 seconds
                        setTimeout(() => delete lastRecognized[match.label], 5000);
                        
                        // Alert for unknown faces
                        if (isUnknown && document.getElementById('alertUnknown').checked) {
                            if (!lastRecognized['unknown']) {
                                alert('Unknown face detected!');
                                lastRecognized['unknown'] = Date.now();
                                setTimeout(() => delete lastRecognized['unknown'], 10000);
                            }
                        }
                        
                        // Alert for specific person
                        if (alertSpecificPerson && match.label === alertSpecificPerson) {
                            if (!lastRecognized['alert_' + match.label]) {
                                alert(`${match.label} detected!`);
                                lastRecognized['alert_' + match.label] = Date.now();
                                setTimeout(() => delete lastRecognized['alert_' + match.label], 10000);
                            }
                        }
                    });
                } else if (detections.length > 0) {
                    detections.forEach(detection => {
                        const box = detection.detection.box;
                        ctx.strokeStyle = '#FF9800';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(box.x, box.y, box.width, box.height);
                        
                        ctx.fillStyle = '#FF9800';
                        ctx.fillRect(box.x, box.y - 25, box.width, 25);
                        
                        ctx.fillStyle = 'white';
                        ctx.font = '14px Arial';
                        ctx.fillText('No faces registered', box.x + 5, box.y - 8);
                    });
                }
            } catch (error) {
                console.error('Detection error:', error);
            }

            requestAnimationFrame(() => detectFaces(video, canvas));
        }

        // Log recognition
        function logRecognition(name, confidence, isUnknown) {
            const timestamp = new Date().toLocaleString();
            const date = new Date().toLocaleDateString();
            
            recognitionHistory.push({
                name: isUnknown ? 'Unknown Person' : name,
                confidence: confidence,
                timestamp: timestamp,
                isUnknown: isUnknown
            });
            
            if (!isUnknown) {
                attendanceLog.push({
                    name: name,
                    confidence: confidence,
                    timestamp: timestamp,
                    date: date
                });
            }
            
            saveData();
        }

        // Capture from camera
        async function captureFromCamera() {
            const video = document.getElementById('videoReg');
            const canvas = document.getElementById('canvasReg');
            const name = document.getElementById('nameInput').value.trim();
            
            if (!name) {
                showMessage('msgReg', 'Please enter a name', 'error');
                return;
            }
            
            if (!cameraStream) {
                showMessage('msgReg', 'Please start camera first', 'error');
                return;
            }
            
            try {
                showMessage('msgReg', 'Detecting face...', 'info');
                
                const detection = await faceapi
                    .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptor();
                
                if (!detection) {
                    showMessage('msgReg', 'No face detected', 'error');
                    return;
                }
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const image = canvas.toDataURL('image/jpeg', 0.8);
                
                registeredFaces.push({
                    id: Date.now(),
                    name: name,
                    image: image,
                    descriptor: Array.from(detection.descriptor),
                    time: new Date().toLocaleString()
                });
                
                document.getElementById('nameInput').value = '';
                showMessage('msgReg', `Registered ${name} successfully!`, 'success');
                saveData();
                updateUI();
            } catch (error) {
                showMessage('msgReg', 'Error: ' + error.message, 'error');
            }
        }

        // Upload photo
        async function uploadPhoto(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const name = document.getElementById('nameInput').value.trim();
            if (!name) {
                showMessage('msgReg', 'Please enter a name', 'error');
                document.getElementById('nameInput').focus();
                return;
            }
            
            try {
                showMessage('msgReg', 'Processing image...', 'info');
                const img = await loadImage(file);
                
                const detection = await faceapi
                    .detectSingleFace(img, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptor();
                
                if (!detection) {
                    showMessage('msgReg', 'No face detected in image', 'error');
                    return;
                }
                
                const smallImg = await resizeImage(img, 200);
                
                registeredFaces.push({
                    id: Date.now(),
                    name: name,
                    image: smallImg,
                    descriptor: Array.from(detection.descriptor),
                    time: new Date().toLocaleString()
                });
                
                document.getElementById('nameInput').value = '';
                event.target.value = '';
                showMessage('msgReg', `Registered ${name} successfully!`, 'success');
                saveData();
                updateUI();
            } catch (error) {
                showMessage('msgReg', 'Error: ' + error.message, 'error');
            }
        }

        // Batch register
        async function batchRegister(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            showMessage('msgReg', `Processing ${files.length} images...`, 'info');
            
            let successCount = 0;
            for (let i = 0; i < files.length; i++) {
                try {
                    const img = await loadImage(files[i]);
                    const detection = await faceapi
                        .detectSingleFace(img, new faceapi.TinyFaceDetectorOptions())
                        .withFaceLandmarks()
                        .withFaceDescriptor();
                    
                    if (detection) {
                        const fileName = files[i].name.replace(/\.[^/.]+$/, "");
                        const smallImg = await resizeImage(img, 200);
                        
                        registeredFaces.push({
                            id: Date.now() + i,
                            name: fileName,
                            image: smallImg,
                            descriptor: Array.from(detection.descriptor),
                            time: new Date().toLocaleString()
                        });
                        successCount++;
                    }
                } catch (error) {
                    console.error(`Error processing ${files[i].name}:`, error);
                }
            }
            
            event.target.value = '';
            showMessage('msgReg', `Successfully registered ${successCount} of ${files.length} faces`, 'success');
            saveData();
            updateUI();
        }

        // Load image
        function loadImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        // Resize image
        function resizeImage(img, maxSize) {
            return new Promise(resolve => {
                const canvas = document.createElement('canvas');
                let w = img.width, h = img.height;
                
                if (w > h) {
                    if (w > maxSize) { h *= maxSize / w; w = maxSize; }
                } else {
                    if (h > maxSize) { w *= maxSize / h; h = maxSize; }
                }
                
                canvas.width = w;
                canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                resolve(canvas.toDataURL('image/jpeg', 0.8));
            });
        }

        // Capture snapshot
        function captureSnapshot() {
            const video = document.getElementById('videoRec');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            snapshots.push({
                image: canvas.toDataURL('image/jpeg', 0.8),
                timestamp: new Date().toLocaleString()
            });
            
            saveData();
            updateSnapshotGallery();
            showMessage('msgRec', 'Snapshot captured!', 'success');
        }

        // Delete snapshot
        function deleteSnapshot(index) {
            snapshots.splice(index, 1);
            saveData();
            updateSnapshotGallery();
        }

        // Clear snapshots
        function clearSnapshots() {
            if (snapshots.length === 0) return;
            if (confirm(`Delete all ${snapshots.length} snapshots?`)) {
                snapshots = [];
                saveData();
                updateSnapshotGallery();
            }
        }

        // Delete face
        function deleteFace(id) {
            registeredFaces = registeredFaces.filter(f => f.id !== id);
            saveData();
            updateUI();
            showMessage('msgReg', 'Face deleted', 'info');
        }

        // Clear all faces
        function clearAll() {
            if (registeredFaces.length === 0) return;
            if (confirm(`Delete all ${registeredFaces.length} registered faces?`)) {
                registeredFaces = [];
                saveData();
                updateUI();
                showMessage('msgReg', 'All faces cleared', 'info');
            }
        }

        // Clear history
        function clearHistory() {
            if (recognitionHistory.length === 0) return;
            if (confirm('Clear all recognition history?')) {
                recognitionHistory = [];
                saveData();
                updateHistory();
            }
        }

        // Export data as JSON
        function exportData() {
            const dataStr = JSON.stringify(registeredFaces, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `face_data_${Date.now()}.json`;
            a.click();
        }

        // Import data
        function importData() {
            document.getElementById('importInput').click();
        }

        // Handle import
        async function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const imported = JSON.parse(text);
                
                if (Array.isArray(imported) && imported.length > 0) {
                    const proceed = confirm(`Import ${imported.length} faces? This will add to existing data.`);
                    if (proceed) {
                        registeredFaces.push(...imported);
                        saveData();
                        updateUI();
                        showMessage('msgReg', `Imported ${imported.length} faces`, 'success');
                    }
                }
            } catch (error) {
                showMessage('msgReg', 'Invalid file format', 'error');
            }
            event.target.value = '';
        }

        // Export attendance CSV
        function exportAttendance() {
            if (attendanceLog.length === 0) {
                alert('No attendance data to export');
                return;
            }
            
            const csv = 'Name,Confidence,Timestamp,Date\n' + 
                attendanceLog.map(log => 
                    `"${log.name}",${log.confidence},"${log.timestamp}","${log.date}"`
                ).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_${Date.now()}.csv`;
            a.click();
        }

        // Compare faces
        async function compareFaces() {
            if (!compareImage1 || !compareImage2) {
                alert('Please upload both images');
                return;
            }
            
            try {
                const resultDiv = document.getElementById('compareResult');
                resultDiv.innerHTML = '<p style="text-align:center;color:var(--text-secondary);">Analyzing...</p>';
                
                const detection1 = await faceapi
                    .detectSingleFace(compareImage1, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptor();
                
                const detection2 = await faceapi
                    .detectSingleFace(compareImage2, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptor();
                
                if (!detection1 || !detection2) {
                    resultDiv.innerHTML = '<div class="card" style="background:var(--bg-primary);"><p style="color:var(--danger);text-align:center;">Could not detect faces in one or both images</p></div>';
                    return;
                }
                
                const distance = faceapi.euclideanDistance(detection1.descriptor, detection2.descriptor);
                const similarity = Math.round((1 - distance) * 100);
                const match = distance < 0.6;
                
                resultDiv.innerHTML = `
                    <div class="card" style="background:var(--bg-primary);">
                        <h3 style="text-align:center;margin-bottom:15px;">Comparison Result</h3>
                        <div class="stat-card">
                            <div class="stat-value" style="color:${match ? 'var(--success)' : 'var(--danger)'}">${similarity}%</div>
                            <div class="stat-label">Similarity Score</div>
                        </div>
                        <p style="text-align:center;margin-top:15px;font-size:18px;font-weight:bold;color:${match ? 'var(--success)' : 'var(--danger)'}">
                            ${match ? 'MATCH - Same person' : 'NO MATCH - Different people'}
                        </p>
                        <p style="text-align:center;margin-top:10px;color:var(--text-secondary);font-size:14px;">
                            Distance: ${distance.toFixed(4)} (Threshold: 0.6)
                        </p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('compareResult').innerHTML = 
                    '<div class="card" style="background:var(--bg-primary);"><p style="color:var(--danger);text-align:center;">Error: ' + error.message + '</p></div>';
            }
        }

        // Handle compare image uploads
        function handleCompareUpload(inputId, previewId, imageNum) {
            const input = document.getElementById(inputId);
            input.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const img = await loadImage(file);
                if (imageNum === 1) compareImage1 = img;
                else compareImage2 = img;
                
                const preview = document.getElementById(previewId);
                preview.innerHTML = `<img src="${img.src}" style="width:100%;height:100%;object-fit:cover;">`;
            });
        }

        // Backup all data
        function backupData() {
            const backup = {
                faces: registeredFaces,
                history: recognitionHistory,
                attendance: attendanceLog,
                snapshots: snapshots,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `full_backup_${Date.now()}.json`;
            a.click();
            
            alert('Full backup downloaded!');
        }

        // Restore data
        function restoreData() {
            document.getElementById('restoreInput').click();
        }

        // Handle restore
        async function handleRestore(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const backup = JSON.parse(text);
                
                if (confirm('Restore from backup? This will replace all current data.')) {
                    registeredFaces = backup.faces || [];
                    recognitionHistory = backup.history || [];
                    attendanceLog = backup.attendance || [];
                    snapshots = backup.snapshots || [];
                    saveData();
                    updateUI();
                    alert('Data restored successfully!');
                }
            } catch (error) {
                alert('Invalid backup file');
            }
            event.target.value = '';
        }

        // Setup event listeners
        function setupEventListeners() {
            // Register tab
            document.getElementById('startCamReg').addEventListener('click', () => startCamera('videoReg', 'register'));
            document.getElementById('captureBtn').addEventListener('click', captureFromCamera);
            document.getElementById('uploadBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('fileInput').addEventListener('change', uploadPhoto);
            document.getElementById('batchRegisterBtn').addEventListener('click', () => document.getElementById('batchFileInput').click());
            document.getElementById('batchFileInput').addEventListener('change', batchRegister);
            document.getElementById('searchInput').addEventListener('input', updateFaceList);
            document.getElementById('importInput').addEventListener('change', handleImport);
            
            // Recognize tab
            document.getElementById('startCamRec').addEventListener('click', () => startCamera('videoRec', 'recognize'));
            document.getElementById('captureSnapshot').addEventListener('click', captureSnapshot);
            
            // Settings
            document.getElementById('thresholdSlider').addEventListener('input', (e) => {
                confidenceThreshold = e.target.value / 100;
                document.getElementById('thresholdValue').textContent = e.target.value + '%';
            });
            
            document.getElementById('speedSlider').addEventListener('input', (e) => {
                detectionSpeed = parseInt(e.target.value);
                const speed = detectionSpeed <= 200 ? 'Fast' : detectionSpeed <= 500 ? 'Medium' : 'Slow';
                document.getElementById('speedValue').textContent = `${speed} (${detectionSpeed}ms)`;
            });
            
            document.getElementById('alertSpecific').addEventListener('change', (e) => {
                document.getElementById('alertPerson').disabled = !e.target.checked;
            });
            
            document.getElementById('alertPerson').addEventListener('change', (e) => {
                alertSpecificPerson = e.target.value;
            });
            
            document.getElementById('restoreInput').addEventListener('change', handleRestore);
            
            // Compare tab
            handleCompareUpload('compare1', 'preview1', 1);
            handleCompareUpload('compare2', 'preview2', 2);
        }

        // Start the application
        init();
    </script>
</body>
</html>
