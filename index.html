
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Face Recognition System</title>
    <style>
    @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
    
    * { 
        margin: 0; 
        padding: 0; 
        box-sizing: border-box; 
    }
    
    :root {
        --bg-primary: #ffffff;
        --bg-secondary: #f8fafc;
        --bg-tertiary: #f1f5f9;
        --text-primary: #0f172a;
        --text-secondary: #475569;
        --text-tertiary: #94a3b8;
        --border-color: #e2e8f0;
        --border-hover: #cbd5e1;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --info: #3b82f6;
        --accent: #2563eb;
        --accent-hover: #1d4ed8;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
    }
    
    body.dark-mode {
        --bg-primary: #0f172a;
        --bg-secondary: #1e293b;
        --bg-tertiary: #334155;
        --text-primary: #f8fafc;
        --text-secondary: #cbd5e1;
        --text-tertiary: #94a3b8;
        --border-color: #334155;
        --border-hover: #475569;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideUp {
        from { 
            opacity: 0; 
            transform: translateY(10px); 
        }
        to { 
            opacity: 1; 
            transform: translateY(0); 
        }
    }
    
    @keyframes scaleIn {
        from { 
            opacity: 0; 
            transform: scale(0.95); 
        }
        to { 
            opacity: 1; 
            transform: scale(1); 
        }
    }
    
    body {
        font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        padding: 24px;
        min-height: 100vh;
        line-height: 1.6;
        transition: background-color 0.2s ease, color 0.2s ease;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    
    .container { 
        max-width: 1400px; 
        margin: 0 auto;
    }
    
    .header {
        text-align: center;
        margin-bottom: 40px;
        animation: slideUp 0.5s ease-out;
    }
    
    .header h1 { 
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
        letter-spacing: -0.02em;
    }
    
    .header p {
        color: var(--text-secondary);
        font-size: 0.95rem;
        font-weight: 500;
    }
    
    .header-controls {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-top: 20px;
        flex-wrap: wrap;
    }
    
    .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 32px;
        overflow-x: auto;
        padding: 8px;
        background: var(--bg-secondary);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        animation: slideUp 0.6s ease-out 0.1s both;
    }
    
    .tabs::-webkit-scrollbar {
        height: 6px;
    }
    
    .tabs::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .tabs::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 3px;
    }
    
    .tab {
        padding: 10px 20px;
        background: transparent;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        color: var(--text-secondary);
        transition: all 0.2s ease;
        white-space: nowrap;
        font-weight: 500;
        font-size: 0.9rem;
    }
    
    .tab:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
    }
    
    .tab.active {
        background: var(--accent);
        color: white;
        box-shadow: var(--shadow-sm);
    }
    
    .tab-content { 
        display: none;
    }
    
    .tab-content.active { 
        display: block;
        animation: fadeIn 0.3s ease-out;
    }
    
    .btn {
        padding: 10px 20px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.9rem;
        cursor: pointer;
        background: var(--bg-primary);
        color: var(--text-primary);
        transition: all 0.2s ease;
        font-weight: 500;
        font-family: inherit;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn:hover:not(:disabled) { 
        background: var(--bg-secondary);
        border-color: var(--border-hover);
        box-shadow: var(--shadow-sm);
    }
    
    .btn:active:not(:disabled) { 
        transform: scale(0.98);
    }
    
    .btn:disabled { 
        opacity: 0.5; 
        cursor: not-allowed; 
    }
    
    .btn-primary { 
        background: var(--accent);
        color: white;
        border-color: var(--accent);
    }
    
    .btn-primary:hover:not(:disabled) {
        background: var(--accent-hover);
        border-color: var(--accent-hover);
    }
    
    .btn-success { 
        background: var(--success);
        color: white;
        border-color: var(--success);
    }
    
    .btn-success:hover:not(:disabled) {
        background: #059669;
        border-color: #059669;
    }
    
    .btn-danger { 
        background: var(--danger);
        color: white;
        border-color: var(--danger);
    }
    
    .btn-danger:hover:not(:disabled) {
        background: #dc2626;
        border-color: #dc2626;
    }
    
    .btn-warning { 
        background: var(--warning);
        color: white;
        border-color: var(--warning);
    }
    
    .btn-warning:hover:not(:disabled) {
        background: #d97706;
        border-color: #d97706;
    }
    
    .grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); 
        gap: 24px; 
        margin-bottom: 24px; 
    }
    
    .card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 24px;
        transition: all 0.2s ease;
        box-shadow: var(--shadow-sm);
    }
    
    .card:hover {
        box-shadow: var(--shadow-md);
        border-color: var(--border-hover);
    }
    
    .card h3 {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 16px;
    }
    
    .video-container {
        position: relative;
        width: 100%;
        background: #000;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        margin-bottom: 20px;
        min-height: 300px;
        overflow: hidden;
        box-shadow: var(--shadow-sm);
    }
    
    video, canvas { 
        width: 100%; 
        display: block;
        border-radius: 9px;
    }
    
    canvas { 
        position: absolute; 
        top: 0; 
        left: 0; 
    }
    
    .controls { 
        display: flex; 
        flex-direction: column; 
        gap: 12px;
    }
    
    input, select, textarea {
        padding: 10px 14px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.9rem;
        background: var(--bg-primary);
        color: var(--text-primary);
        transition: all 0.2s ease;
        font-family: inherit;
    }
    
    input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .slider-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 16px;
    }
    
    .slider-container label {
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-secondary);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .slider-container label span {
        color: var(--text-primary);
        font-weight: 600;
    }
    
    .slider {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: var(--bg-tertiary);
        outline: none;
        -webkit-appearance: none;
        cursor: pointer;
    }
    
    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--accent);
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: var(--shadow-sm);
    }
    
    .slider::-webkit-slider-thumb:hover {
        background: var(--accent-hover);
        box-shadow: var(--shadow-md);
    }
    
    .slider::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--accent);
        cursor: pointer;
        border: none;
        transition: all 0.2s ease;
        box-shadow: var(--shadow-sm);
    }
    
    .slider::-moz-range-thumb:hover {
        background: var(--accent-hover);
        box-shadow: var(--shadow-md);
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }
    
    .stat-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        padding: 24px;
        border-radius: 12px;
        text-align: center;
        transition: all 0.2s ease;
        box-shadow: var(--shadow-sm);
    }
    
    .stat-card:hover {
        box-shadow: var(--shadow-md);
        border-color: var(--border-hover);
    }
    
    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--accent);
        line-height: 1;
        font-family: 'JetBrains Mono', monospace;
    }
    
    .stat-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-top: 8px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .face-list {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .face-list::-webkit-scrollbar {
        width: 8px;
    }
    
    .face-list::-webkit-scrollbar-track {
        background: var(--bg-secondary);
        border-radius: 4px;
    }
    
    .face-list::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 4px;
    }
    
    .face-list::-webkit-scrollbar-thumb:hover {
        background: var(--border-hover);
    }
    
    .face-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        margin-bottom: 8px;
        transition: all 0.2s ease;
    }
    
    .face-item:hover {
        background: var(--bg-tertiary);
        box-shadow: var(--shadow-sm);
    }
    
    .face-item img {
        width: 56px;
        height: 56px;
        border: 2px solid var(--border-color);
        object-fit: cover;
        border-radius: 8px;
    }
    
    .face-info { 
        flex: 1; 
    }
    
    .face-name {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.95rem;
    }
    
    .face-time {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: 2px;
    }
    
    .badge {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .badge-success { 
        background: #d1fae5;
        color: #065f46;
    }
    
    body.dark-mode .badge-success {
        background: rgba(16, 185, 129, 0.2);
        color: #6ee7b7;
    }
    
    .badge-danger { 
        background: #fee2e2;
        color: #991b1b;
    }
    
    body.dark-mode .badge-danger {
        background: rgba(239, 68, 68, 0.2);
        color: #fca5a5;
    }
    
    .badge-info { 
        background: #dbeafe;
        color: #1e40af;
    }
    
    body.dark-mode .badge-info {
        background: rgba(59, 130, 246, 0.2);
        color: #93c5fd;
    }
    
    .badge-warning { 
        background: #fef3c7;
        color: #92400e;
    }
    
    body.dark-mode .badge-warning {
        background: rgba(245, 158, 11, 0.2);
        color: #fcd34d;
    }
    
    .log-entry {
        padding: 12px 16px;
        border-left: 3px solid var(--accent);
        background: var(--bg-secondary);
        margin-bottom: 8px;
        border-radius: 0 8px 8px 0;
        transition: all 0.2s ease;
    }
    
    .log-entry:hover {
        background: var(--bg-tertiary);
    }
    
    .log-entry strong {
        color: var(--text-primary);
        font-weight: 600;
    }
    
    .log-time {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: 4px;
        display: block;
    }
    
    .message {
        padding: 12px 16px;
        border-radius: 8px;
        margin-top: 12px;
        text-align: center;
        display: none;
        font-weight: 500;
        font-size: 0.9rem;
        border: 1px solid;
    }
    
    .message.show { 
        display: block;
        animation: slideUp 0.3s ease-out;
    }
    
    .live-count {
        position: absolute;
        top: 12px;
        right: 12px;
        background: var(--accent);
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
        box-shadow: var(--shadow-md);
        font-family: 'JetBrains Mono', monospace;
    }
    
    .search-box {
        position: relative;
        margin-bottom: 16px;
    }
    
    .search-box input {
        width: 100%;
        padding-left: 40px;
    }
    
    .search-box::before {
        content: 'üîç';
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 16px;
        opacity: 0.5;
    }
    
    .snapshot-item {
        position: relative;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        overflow: hidden;
        transition: all 0.2s ease;
        background: var(--bg-secondary);
    }
    
    .snapshot-item:hover {
        box-shadow: var(--shadow-md);
        border-color: var(--border-hover);
    }
    
    .snapshot-item img {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }
    
    .snapshot-info {
        padding: 8px 12px;
        background: var(--bg-primary);
        font-size: 0.8rem;
        color: var(--text-secondary);
        border-top: 1px solid var(--border-color);
    }
    
    .chart-bar {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        gap: 12px;
    }
    
    .chart-label {
        min-width: 100px;
        font-size: 0.9rem;
        color: var(--text-primary);
        font-weight: 500;
    }
    
    .chart-bar-fill {
        height: 32px;
        background: var(--accent);
        border-radius: 6px;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-sm);
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 12px;
        color: white;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .chart-bar:hover .chart-bar-fill {
        box-shadow: var(--shadow-md);
    }
    
    .chart-value {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
        min-width: 40px;
        text-align: right;
        font-family: 'JetBrains Mono', monospace;
    }
    
    label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        color: var(--text-secondary);
        cursor: pointer;
        user-select: none;
    }
    
    input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: var(--accent);
    }
    
    @media (max-width: 768px) {
        .grid { 
            grid-template-columns: 1fr; 
        }
        
        .header h1 { 
            font-size: 2rem; 
        }
        
        body {
            padding: 16px;
        }
    }
    
    /* Dark mode specific enhancements */
    body.dark-mode .card {
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.3);
    }
    
    body.dark-mode .card:hover {
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.3);
    }
    
    /* Smooth transitions */
    * {
        transition-property: background-color, border-color, color, fill, stroke;
        transition-duration: 0.2s;
        transition-timing-function: ease;
    }
    
    button, input, select, textarea {
        transition-property: all;
    }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Ultimate Face Recognition System</h1>
            <p style="color: var(--text-secondary);">Made By Aakshat Hariharan</p>
            <p style="color: var(--text-secondary); font-size: 12px; margin-top: 5px;">
                Logged in as: <strong id="currentUserDisplay"></strong> 
                <button class="btn btn-danger" onclick="logout()" style="padding: 4px 12px; font-size: 12px; margin-left: 10px;">Logout</button>
            </p>
            <div class="header-controls">
                <button class="btn" onclick="toggleDarkMode()" id="darkModeBtn">Dark Mode</button>
                <button class="btn btn-warning" onclick="toggleVoice()" id="voiceBtn">Voice: OFF</button>
            </div>
            <div style="display:flex;gap:10px;justify-content:center;margin-top:15px;flex-wrap:wrap;">
                <a href="index.html" class="btn btn-primary" style="text-decoration:none;">Ultimate Version</a>
                <a href="regular.html" class="btn" style="text-decoration:none;">Regular Version</a>
                <a href="deepfake.html" class="btn" style="text-decoration:none;">Deepfake Detection</a>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('register')">Register</div>
            <div class="tab" onclick="switchTab('recognize')">Recognize</div>
            <div class="tab" onclick="switchTab('attendance')">Attendance</div>
            <div class="tab" onclick="switchTab('analytics')">Analytics</div>
            <div class="tab" onclick="switchTab('history')">History</div>
            <div class="tab" onclick="switchTab('compare')">Compare</div>
            <div class="tab" onclick="switchTab('aifeatures')">AI Features</div>
            <div class="tab" onclick="switchTab('settings')">Settings</div>
        </div>

        <!-- REGISTER TAB -->
        <div id="register" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h3 style="margin-bottom: 15px;">Camera</h3>
                    <div class="video-container">
                        <video id="videoReg" autoplay muted playsinline></video>
                        <canvas id="overlayReg"></canvas>
                        <div class="live-count" id="liveCountReg">Faces: 0</div>
                    </div>
                    <canvas id="canvasReg" style="display:none;"></canvas>

                    <div class="controls">
                        <select id="cameraSelect">
                            <option value="">Select Camera</option>
                        </select>
                        <button class="btn btn-primary" id="startCamReg">Start Camera</button>
                        <input type="text" id="nameInput" placeholder="Enter name...">
                        <div style="display:flex;gap:10px;">
                            <button class="btn btn-success" id="captureBtn" style="flex:1;">Capture</button>
                            <button class="btn" id="uploadBtn" style="flex:1;">Upload Photo</button>
                        </div>
                        <button class="btn btn-info" id="batchRegisterBtn">Batch Register (Multiple)</button>
                        <input type="file" id="fileInput" accept="image/*" style="display:none;">
                        <input type="file" id="batchFileInput" accept="image/*" multiple style="display:none;">
                        
                        <div style="border-top:1px solid var(--border-color);padding-top:10px;margin-top:5px;">
                            <p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">Import photos (PNG/HEIF) or database (JSON)</p>
                            <button class="btn btn-info" id="importPhotosBtn" style="width:100%;">Import Photos (PNG/HEIF)</button>
                            <input type="file" id="photoImportInput" accept="image/*" multiple style="display:none;">
                        </div>
                    </div>
                    <div class="message" id="msgReg"></div>
                </div>

                <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                        <h3>Registered Faces</h3>
                        <span class="badge badge-info" id="faceCount">0</span>
                    </div>
                    <div class="search-box">
                        <input type="search" id="searchInput" placeholder="Search faces...">
                    </div>
                    <div style="display:flex;gap:8px;margin-bottom:15px;">
                        <button class="btn btn-info" onclick="exportData()" style="flex:1;">Export DB</button>
                        <button class="btn btn-warning" onclick="importData()" style="flex:1;">Import DB</button>
                        <button class="btn btn-danger" onclick="clearAll()" style="flex:1;">Clear All</button>
                    </div>
                    <input type="file" id="importInput" accept=".json" style="display:none;">
                    <div class="face-list" id="faceList"></div>
                </div>
            </div>
        </div>

        <!-- RECOGNIZE TAB -->
        <div id="recognize" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h3 style="margin-bottom: 15px;">Live Recognition</h3>
                    <div class="video-container">
                        <video id="videoRec" autoplay muted playsinline></video>
                        <canvas id="overlayRec"></canvas>
                        <div class="live-count" id="liveCountRec">Faces: 0</div>
                    </div>

                    <div class="controls">
                        <button class="btn btn-primary" id="startCamRec">Start Recognition</button>
                        <button class="btn btn-success" id="captureSnapshot">Capture Snapshot</button>
                        <label style="display:flex;align-items:center;gap:8px;">
                            <input type="checkbox" id="blurUnknown"> Blur Unknown Faces
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;">
                            <input type="checkbox" id="alertUnknown"> Alert on Unknown Face
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;">
                            <input type="checkbox" id="showAgeGender" checked> Show Age & Gender
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;">
                            <input type="checkbox" id="showExpressions" checked> Show Expressions
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;">
                            <input type="checkbox" id="showConfidence" checked> Show Confidence Score
                        </label>
                    </div>
                    <div class="message" id="msgRec"></div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 15px;">Captured Snapshots</h3>
                    <button class="btn btn-danger" onclick="clearSnapshots()" style="width:100%;margin-bottom:15px;">Clear All Snapshots</button>
                    <div id="snapshotGallery" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;max-height:400px;overflow-y:auto;"></div>
                </div>
            </div>
        </div>

        <!-- ATTENDANCE TAB -->
        <div id="attendance" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="todayCount">0</div>
                    <div class="stat-label">Today's Visits</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="uniqueToday">0</div>
                    <div class="stat-label">Unique Visitors</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalRecognitions">0</div>
                    <div class="stat-label">Total Recognitions</div>
                </div>
            </div>

            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                    <h3>Attendance Log</h3>
                    <button class="btn btn-info" onclick="exportAttendance()">Export CSV</button>
                </div>
                <div style="max-height:500px;overflow-y:auto;" id="attendanceLog"></div>
            </div>
        </div>

        <!-- ANALYTICS TAB -->
        <div id="analytics" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="avgConfidence">0%</div>
                    <div class="stat-label">Average Confidence</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="mostFrequent">-</div>
                    <div class="stat-label">Most Frequent</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalDetections">0</div>
                    <div class="stat-label">Total Detections</div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom:15px;">Top 5 Most Recognized</h3>
                <div id="topRecognized"></div>
            </div>
        </div>

        <!-- HISTORY TAB -->
        <div id="history" class="tab-content">
            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                    <h3>Recognition History</h3>
                    <button class="btn btn-danger" onclick="clearHistory()">Clear History</button>
                </div>
                <div style="max-height:600px;overflow-y:auto;" id="historyLog"></div>
            </div>
        </div>

        <!-- COMPARE TAB -->
        <div id="compare" class="tab-content">
            <div class="card">
                <h3 style="margin-bottom:15px;">Face Comparison Tool</h3>
                <p style="color:var(--text-secondary);margin-bottom:20px;">Upload two photos to compare facial similarity</p>
                <div class="grid">
                    <div>
                        <h4 style="margin-bottom:10px;">Face 1</h4>
                        <input type="file" id="compare1" accept="image/*" style="margin-bottom:10px;">
                        <div id="preview1" style="width:100%;height:250px;background:var(--bg-primary);border:2px dashed var(--border-color);border-radius:4px;display:flex;align-items:center;justify-content:center;overflow:hidden;">
                            <span style="color:var(--text-secondary);">No image selected</span>
                        </div>
                    </div>
                    <div>
                        <h4 style="margin-bottom:10px;">Face 2</h4>
                        <input type="file" id="compare2" accept="image/*" style="margin-bottom:10px;">
                        <div id="preview2" style="width:100%;height:250px;background:var(--bg-primary);border:2px dashed var(--border-color);border-radius:4px;display:flex;align-items:center;justify-content:center;overflow:hidden;">
                            <span style="color:var(--text-secondary);">No image selected</span>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="compareFaces()" style="width:100%;margin-top:15px;">Compare Faces</button>
                <div id="compareResult" style="margin-top:20px;"></div>
            </div>
        </div>

        <!-- AI FEATURES TAB -->
        <div id="aifeatures" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h3 style="margin-bottom:15px;">Auto-Training System</h3>
                    <p style="color:var(--text-secondary);margin-bottom:15px;">Automatically improve recognition by learning from detections</p>
                    
                    <div class="stat-card" style="margin-bottom:15px;">
                        <div class="stat-value" id="trainingCount">0</div>
                        <div class="stat-label">Training Samples Collected</div>
                    </div>
                    
                    <label style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                        <input type="checkbox" id="autoTraining"> Enable Auto-Training
                    </label>
                    <p style="font-size:12px;color:var(--text-secondary);margin-bottom:15px;">Automatically collect high-quality detections to improve accuracy</p>
                    
                    <div class="slider-container">
                        <label>Training Quality Threshold: <span id="trainingQualityValue">60%</span></label>
                        <p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">Only collect samples with confidence above this</p>
                        <input type="range" id="trainingQualitySlider" class="slider" min="50" max="98" value="60">
                    </div>
                    
                    <button class="btn btn-success" onclick="applyTraining()" style="width:100%;margin-top:10px;">Apply Training Data</button>
                    <button class="btn btn-danger" onclick="clearTraining()" style="width:100%;margin-top:10px;">Clear Training Data</button>
                </div>

                <div class="card">
                    <h3 style="margin-bottom:15px;">Face Tracking</h3>
                    <p style="color:var(--text-secondary);margin-bottom:15px;">Advanced tracking of detected faces</p>
                    
                    <label style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                        <input type="checkbox" id="faceFollowing"> Enable Face Following
                    </label>
                    <p style="font-size:12px;color:var(--text-secondary);margin-bottom:15px;">Track faces as they move across the frame</p>
                    
                    <label style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                        <input type="checkbox" id="showTrajectory"> Show Movement Trajectory
                    </label>
                    <p style="font-size:12px;color:var(--text-secondary);margin-bottom:15px;">Display path of face movement</p>
                    
                    <div class="stat-card" style="margin-bottom:15px;">
                        <div class="stat-value" id="trackedFaces">0</div>
                        <div class="stat-label">Currently Tracked Faces</div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3 style="margin-bottom:15px;">Anomaly Detection</h3>
                <p style="color:var(--text-secondary);margin-bottom:15px;">Detect unusual patterns in face recognition data</p>
                
                <label style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                    <input type="checkbox" id="anomalyDetection"> Enable Anomaly Detection
                </label>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:15px;">
                    <div>
                        <h4 style="margin-bottom:10px;">Detection Rules</h4>
                        <label style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <input type="checkbox" id="detectMultipleUnknown" checked> Multiple Unknown Faces
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <input type="checkbox" id="detectUnusualTimes" checked> Unusual Time Access
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <input type="checkbox" id="detectRapidEntry" checked> Rapid Entry/Exit
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <input type="checkbox" id="detectLowConfidence" checked> Frequent Low Confidence
                        </label>
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom:10px;">Anomaly Log</h4>
                        <div id="anomalyLog" style="max-height:150px;overflow-y:auto;background:var(--bg-primary);padding:10px;border-radius:4px;font-size:12px;">
                            <p style="color:var(--text-secondary);">No anomalies detected</p>
                        </div>
                        <button class="btn btn-danger" onclick="clearAnomalies()" style="width:100%;margin-top:10px;">Clear Anomalies</button>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3 style="margin-bottom:15px;">Duplicate Face Detection</h3>
                <p style="color:var(--text-secondary);margin-bottom:15px;">Find and merge duplicate face registrations</p>
                
                <button class="btn btn-primary" onclick="scanDuplicates()" style="width:100%;margin-bottom:15px;">Scan for Duplicates</button>
                
                <div id="duplicateResults" style="max-height:300px;overflow-y:auto;"></div>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="settings" class="tab-content">
            <div class="card">
                <h3 style="margin-bottom:20px;">Recognition Settings</h3>
                
                <div class="slider-container">
                    <label><strong>Confidence Threshold:</strong> <span id="thresholdValue">60%</span></label>
                    <p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">Higher values require more accurate matches</p>
                    <input type="range" id="thresholdSlider" class="slider" min="30" max="90" value="60">
                </div>

                <div class="slider-container">
                    <label><strong>Detection Speed:</strong> <span id="speedValue">Medium (200ms)</span></label>
                    <p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">Lower values = faster detection (uses more CPU)</p>
                    <input type="range" id="speedSlider" class="slider" min="100" max="1000" value="200" step="100">
                </div>

                <div class="slider-container">
                    <label><strong>Attendance Logging Cooldown:</strong> <span id="cooldownValue">5 minutes</span></label>
                    <p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">Time between attendance logs for same person</p>
                    <input type="range" id="cooldownSlider" class="slider" min="60000" max="600000" value="300000" step="60000">
                </div>

                <div style="border-top:1px solid var(--border-color);padding-top:20px;margin-top:20px;">
                    <h4 style="margin-bottom:15px;">Alert Settings</h4>
                    <label style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                        <input type="checkbox" id="alertSpecific"> Alert for Specific People
                    </label>
                    <select id="alertPerson" style="width:100%;" disabled>
                        <option value="">Select person to alert</option>
                    </select>
                </div>

                <div style="border-top:1px solid var(--border-color);padding-top:20px;margin-top:20px;">
                    <h4 style="margin-bottom:15px;">Data Management</h4>
                    <button class="btn btn-warning" onclick="backupData()" style="width:100%;margin-bottom:10px;">Backup All Data</button>
                    <button class="btn btn-info" onclick="restoreData()" style="width:100%;">Restore Data</button>
                    <input type="file" id="restoreInput" accept=".json" style="display:none;">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
    <script>
        // ==================== AUTHENTICATION CHECK ====================
        // Check if this is first-time setup (no faces registered)
        let savedFaces = null;
        let isFirstTimeSetup = false;
        
        try {
            savedFaces = localStorage.getItem('registeredFaces');
            isFirstTimeSetup = !savedFaces || JSON.parse(savedFaces).length === 0;
        } catch (error) {
            console.error('Error checking registered faces:', error);
            isFirstTimeSetup = true;
        }

        // Check if user is authenticated
        const isAuthenticated = sessionStorage.getItem('isAuthenticated');
        const currentUser = sessionStorage.getItem('currentUser');

        // Allow access if authenticated OR if it's first-time setup
        if (!isAuthenticated && !isFirstTimeSetup) {
            // Redirect to sign-in page if not authenticated and not first-time setup
            window.location.href = 'signin.html';
        } else if (isFirstTimeSetup && !isAuthenticated) {
            // If first-time setup, set a temporary session
            sessionStorage.setItem('isAuthenticated', 'true');
            sessionStorage.setItem('currentUser', 'Setup User');
            console.log('First-time setup mode - no authentication required');
        } else if (currentUser) {
            console.log('Welcome, ' + currentUser + '!');
        }
        // ==============================================================

        // Global variables
        let cameraStream = null;
        let registeredFaces = [];
        let aiModelsReady = false;
        let currentTab = 'register';
        let isDetecting = false;
        let recognitionHistory = [];
        let attendanceLog = [];
        let snapshots = [];
        let compareImage1 = null;
        let compareImage2 = null;
        let lastRecognized = {};
        let lastLogged = {};
        let activeFaces = {};
        let trainingData = {};
        let faceTrajectories = {};
        let anomalies = [];
        
        // Settings object to store all preferences
        let settings = {
            confidenceThreshold: 60,
            detectionSpeed: 200,
            attendanceCooldown: 300000,
            alertSpecific: false,
            alertPerson: '',
            autoTraining: false,
            trainingQuality: 60,
            faceFollowing: false,
            showTrajectory: false,
            anomalyDetection: false,
            detectMultipleUnknown: true,
            detectUnusualTimes: true,
            detectRapidEntry: true,
            detectLowConfidence: true,
            blurUnknown: false,
            alertUnknown: false,
            showAgeGender: true,
            showExpressions: true,
            showConfidence: true,
            darkMode: false,
            voiceEnabled: false
        };

        // Initialize
        async function init() {
            // Display current user (or setup mode)
            const userDisplay = document.getElementById('currentUserDisplay');
            if (isFirstTimeSetup) {
                userDisplay.textContent = 'First-Time Setup';
                userDisplay.style.color = '#FF9800';
                
                // Show setup message
                showMessage('msgReg', 'Welcome! Register your first face to get started.', 'info');
            } else {
                userDisplay.textContent = currentUser;
            }
            
            await loadModels();
            await loadCameras();
            loadStoredData();
            loadSettings();
            applySettings();
            updateUI();
            setupEventListeners();
        }

        // Logout function
        function logout() {
            // Check if there are any registered faces
            if (registeredFaces.length === 0) {
                alert('You must register at least one face before logging out.');
                return;
            }
            
            if (confirm('Are you sure you want to logout?')) {
                sessionStorage.removeItem('isAuthenticated');
                sessionStorage.removeItem('currentUser');
                window.location.href = 'signin.html';
            }
        }

        // Load AI models
        async function loadModels() {
            const modelUrl = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
            try {
                showMessage('msgReg', 'Loading AI models...', 'info');
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(modelUrl),
                    faceapi.nets.faceLandmark68Net.loadFromUri(modelUrl),
                    faceapi.nets.faceRecognitionNet.loadFromUri(modelUrl),
                    faceapi.nets.ageGenderNet.loadFromUri(modelUrl),
                    faceapi.nets.faceExpressionNet.loadFromUri(modelUrl)
                ]);
                aiModelsReady = true;
                showMessage('msgReg', 'Models loaded successfully!', 'success');
                setTimeout(() => document.getElementById('msgReg').classList.remove('show'), 2000);
            } catch (error) {
                showMessage('msgReg', 'Failed to load AI models', 'error');
                console.error(error);
            }
        }

        // Load available cameras
        async function loadCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cameras = devices.filter(d => d.kind === 'videoinput');
                const select = document.getElementById('cameraSelect');
                cameras.forEach((cam, i) => {
                    const opt = document.createElement('option');
                    opt.value = cam.deviceId;
                    opt.textContent = cam.label || `Camera ${i + 1}`;
                    select.appendChild(opt);
                });
                if (cameras.length > 0) select.value = cameras[0].deviceId;
            } catch (error) {
                console.error('Camera enumeration failed:', error);
            }
        }

        // Load stored data
        function loadStoredData() {
            try {
                let faces = localStorage.getItem('registeredFaces');
                if (!faces) faces = localStorage.getItem('faces');
                
                registeredFaces = JSON.parse(faces || '[]');
                recognitionHistory = JSON.parse(localStorage.getItem('history') || '[]');
                attendanceLog = JSON.parse(localStorage.getItem('attendance') || '[]');
                snapshots = JSON.parse(localStorage.getItem('snapshots') || '[]');
                trainingData = JSON.parse(localStorage.getItem('trainingData') || '{}');
                anomalies = JSON.parse(localStorage.getItem('anomalies') || '[]');
            } catch (error) {
                console.error('Failed to load data:', error);
            }
        }

        // Load settings
        function loadSettings() {
            try {
                const saved = localStorage.getItem('settings');
                if (saved) {
                    const loaded = JSON.parse(saved);
                    settings = { ...settings, ...loaded };
                }
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }

        // Apply settings to UI
        function applySettings() {
            // Regular settings
            document.getElementById('thresholdSlider').value = settings.confidenceThreshold;
            document.getElementById('thresholdValue').textContent = settings.confidenceThreshold + '%';
            
            document.getElementById('speedSlider').value = settings.detectionSpeed;
            const speed = settings.detectionSpeed <= 200 ? 'Fast' : settings.detectionSpeed <= 500 ? 'Medium' : 'Slow';
            document.getElementById('speedValue').textContent = `${speed} (${settings.detectionSpeed}ms)`;
            
            document.getElementById('cooldownSlider').value = settings.attendanceCooldown;
            const minutes = Math.round(settings.attendanceCooldown / 60000);
            document.getElementById('cooldownValue').textContent = `${minutes} minute${minutes !== 1 ? 's' : ''}`;
            
            document.getElementById('alertSpecific').checked = settings.alertSpecific;
            document.getElementById('alertPerson').disabled = !settings.alertSpecific;
            document.getElementById('alertPerson').value = settings.alertPerson;
            
            // Recognition options
            document.getElementById('blurUnknown').checked = settings.blurUnknown;
            document.getElementById('alertUnknown').checked = settings.alertUnknown;
            document.getElementById('showAgeGender').checked = settings.showAgeGender;
            document.getElementById('showExpressions').checked = settings.showExpressions;
            document.getElementById('showConfidence').checked = settings.showConfidence;
            
            // AI Features
            document.getElementById('autoTraining').checked = settings.autoTraining;
            document.getElementById('trainingQualitySlider').value = settings.trainingQuality;
            document.getElementById('trainingQualityValue').textContent = settings.trainingQuality + '%';
            
            document.getElementById('faceFollowing').checked = settings.faceFollowing;
            document.getElementById('showTrajectory').checked = settings.showTrajectory;
            document.getElementById('anomalyDetection').checked = settings.anomalyDetection;
            
            document.getElementById('detectMultipleUnknown').checked = settings.detectMultipleUnknown;
            document.getElementById('detectUnusualTimes').checked = settings.detectUnusualTimes;
            document.getElementById('detectRapidEntry').checked = settings.detectRapidEntry;
            document.getElementById('detectLowConfidence').checked = settings.detectLowConfidence;
            
            // Dark mode
            if (settings.darkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeBtn').textContent = 'Light Mode';
            }
            
            // Voice
            if (settings.voiceEnabled) {
                document.getElementById('voiceBtn').textContent = 'Voice: ON';
            }
        }

        // Save settings
        function saveSettings() {
            try {
                localStorage.setItem('settings', JSON.stringify(settings));
            } catch (error) {
                console.error('Failed to save settings:', error);
            }
        }

        // Save data
        function saveData() {
            try {
                localStorage.setItem('registeredFaces', JSON.stringify(registeredFaces));
                localStorage.setItem('history', JSON.stringify(recognitionHistory));
                localStorage.setItem('attendance', JSON.stringify(attendanceLog));
                localStorage.setItem('snapshots', JSON.stringify(snapshots));
                localStorage.setItem('trainingData', JSON.stringify(trainingData));
                localStorage.setItem('anomalies', JSON.stringify(anomalies));
            } catch (error) {
                console.error('Failed to save data:', error);
            }
        }

        // Update all UI elements
        function updateUI() {
            updateFaceList();
            updateAttendance();
            updateHistory();
            updateAnalytics();
            updateSnapshotGallery();
            updateAlertPersonList();
        }

        // Update face list
        function updateFaceList() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = registeredFaces.filter(f => f.name.toLowerCase().includes(searchTerm));
            
            document.getElementById('faceCount').textContent = registeredFaces.length;
            
            const list = document.getElementById('faceList');
            if (filtered.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:20px;">No faces found</p>';
                return;
            }
            
            list.innerHTML = filtered.map(face => `
                <div class="face-item">
                    <img src="${face.image}" alt="${face.name}">
                    <div class="face-info">
                        <div class="face-name">${face.name}</div>
                        <div class="face-time">${face.time}</div>
                        ${face.imageCount > 1 ? `<div style="font-size:11px;color:var(--info);margin-top:2px;">${face.imageCount} photos in profile</div>` : ''}
                    </div>
                    <button class="btn btn-danger" onclick="deleteFace(${face.id})" style="padding:8px 12px;">Delete</button>
                </div>
            `).join('');
        }

        // Update attendance
        function updateAttendance() {
            const today = new Date().toLocaleDateString();
            const todayLogs = attendanceLog.filter(log => log.date === today);
            const uniqueNames = [...new Set(todayLogs.map(log => log.name))];
            
            document.getElementById('todayCount').textContent = todayLogs.length;
            document.getElementById('uniqueToday').textContent = uniqueNames.length;
            document.getElementById('totalRecognitions').textContent = attendanceLog.length;
            
            const logDiv = document.getElementById('attendanceLog');
            if (attendanceLog.length === 0) {
                logDiv.innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:20px;">No attendance records</p>';
                return;
            }
            
            logDiv.innerHTML = attendanceLog.slice().reverse().map(log => `
                <div class="log-entry">
                    <strong>${log.name}</strong> - ${log.confidence}% confidence
                    <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">
                        Age: ${log.age || 'N/A'}, Gender: ${log.gender || 'N/A'}, Mood: ${log.expression || 'N/A'}
                    </div>
                    <div class="log-time">${log.timestamp}</div>
                </div>
            `).join('');
        }

        // Update history
        function updateHistory() {
            const logDiv = document.getElementById('historyLog');
            if (recognitionHistory.length === 0) {
                logDiv.innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:20px;">No recognition history</p>';
                return;
            }
            
            logDiv.innerHTML = recognitionHistory.slice().reverse().map(log => `
                <div class="log-entry" style="border-left-color:${log.isUnknown ? 'var(--danger)' : 'var(--success)'}">
                    <strong>${log.name}</strong>${log.isUnknown ? '' : ' - ' + log.confidence + '% confidence'}
                    <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">
                        ${log.age ? `Age: ${log.age}, Gender: ${log.gender}, Expression: ${log.expression}` : ''}
                    </div>
                    <div class="log-time">${log.timestamp}</div>
                </div>
            `).join('');
        }

        // Update analytics
        function updateAnalytics() {
            if (recognitionHistory.length === 0) {
                document.getElementById('avgConfidence').textContent = '0%';
                document.getElementById('mostFrequent').textContent = '-';
                document.getElementById('totalDetections').textContent = '0';
                document.getElementById('topRecognized').innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:20px;">No data available</p>';
                return;
            }
            
            const recognized = recognitionHistory.filter(h => !h.isUnknown);
            const avgConf = recognized.length > 0 
                ? Math.round(recognized.reduce((sum, h) => sum + h.confidence, 0) / recognized.length)
                : 0;
            document.getElementById('avgConfidence').textContent = avgConf + '%';
            
            const nameCounts = {};
            recognized.forEach(h => {
                nameCounts[h.name] = (nameCounts[h.name] || 0) + 1;
            });
            const sortedNames = Object.entries(nameCounts).sort((a, b) => b[1] - a[1]);
            document.getElementById('mostFrequent').textContent = sortedNames.length > 0 ? sortedNames[0][0] : '-';
            document.getElementById('totalDetections').textContent = recognitionHistory.length;
            
            const top5 = sortedNames.slice(0, 5);
            const maxCount = top5.length > 0 ? top5[0][1] : 1;
            document.getElementById('topRecognized').innerHTML = top5.length > 0 ? top5.map(([name, count]) => `
                <div class="chart-bar">
                    <div class="chart-label">${name}</div>
                    <div class="chart-bar-fill" style="width:${(count / maxCount) * 60}%;"></div>
                    <div class="chart-value">${count}</div>
                </div>
            `).join('') : '<p style="text-align:center;color:var(--text-secondary);padding:20px;">No data available</p>';
        }

        // Update snapshot gallery
        function updateSnapshotGallery() {
            const gallery = document.getElementById('snapshotGallery');
            if (snapshots.length === 0) {
                gallery.innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:20px;grid-column:1/-1;">No snapshots captured</p>';
                return;
            }
            
            gallery.innerHTML = snapshots.map((snap, i) => `
                <div class="snapshot-item">
                    <img src="${snap.image}" alt="Snapshot ${i + 1}">
                    <div class="snapshot-info">
                        ${snap.timestamp}
                        <button onclick="deleteSnapshot(${i})" style="float:right;background:var(--danger);color:white;border:none;padding:2px 6px;border-radius:3px;cursor:pointer;">√ó</button>
                    </div>
                </div>
            `).join('');
        }

        // Update alert person list
        function updateAlertPersonList() {
            const select = document.getElementById('alertPerson');
            select.innerHTML = '<option value="">Select person to alert</option>' +
                registeredFaces.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
            select.value = settings.alertPerson;
        }

        // Switch tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const tabs = ['register', 'recognize', 'attendance', 'analytics', 'history', 'compare', 'aifeatures', 'settings'];
            const tabIndex = tabs.indexOf(tabName);
            if (tabIndex >= 0) {
                document.querySelectorAll('.tab')[tabIndex].classList.add('active');
            }
            const tabContent = document.getElementById(tabName);
            if (tabContent) {
                tabContent.classList.add('active');
            }
            currentTab = tabName;
            
            if (tabName === 'analytics') updateAnalytics();
            if (tabName === 'attendance') updateAttendance();
            if (tabName === 'history') updateHistory();
            if (tabName === 'aifeatures') updateAIFeatures();
        }

        // Toggle dark mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const btn = document.getElementById('darkModeBtn');
            settings.darkMode = document.body.classList.contains('dark-mode');
            btn.textContent = settings.darkMode ? 'Light Mode' : 'Dark Mode';
            saveSettings();
        }

        // Toggle voice
        function toggleVoice() {
            settings.voiceEnabled = !settings.voiceEnabled;
            document.getElementById('voiceBtn').textContent = settings.voiceEnabled ? 'Voice: ON' : 'Voice: OFF';
            saveSettings();
        }

        // Speak name
        function speak(text) {
            if (!settings.voiceEnabled || !window.speechSynthesis) return;
            const utterance = new SpeechSynthesisUtterance(text);
            speechSynthesis.speak(utterance);
        }

        // Show message
        function showMessage(id, text, type) {
            const msg = document.getElementById(id);
            msg.textContent = text;
            msg.className = 'message show';
            msg.style.background = type === 'success' ? '#dff0d8' : type === 'error' ? '#f2dede' : '#d9edf7';
            msg.style.color = type === 'success' ? '#3c763d' : type === 'error' ? '#a94442' : '#31708f';
        }

        // Start camera
        async function startCamera(videoId, mode) {
            const video = document.getElementById(videoId);
            const btn = document.getElementById(mode === 'register' ? 'startCamReg' : 'startCamRec');
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(t => t.stop());
                cameraStream = null;
                video.srcObject = null;
                btn.textContent = mode === 'register' ? 'Start Camera' : 'Start Recognition';
                btn.className = 'btn btn-primary';
                isDetecting = false;
                const overlay = document.getElementById(mode === 'register' ? 'overlayReg' : 'overlayRec');
                overlay.getContext('2d').clearRect(0, 0, overlay.width, overlay.height);
                return;
            }

            if (!aiModelsReady) {
                showMessage(mode === 'register' ? 'msgReg' : 'msgRec', 'AI models still loading...', 'error');
                return;
            }

            const deviceId = document.getElementById('cameraSelect').value;
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { deviceId: deviceId || undefined, width: 640, height: 480 }
                });
                video.srcObject = cameraStream;
                await new Promise(resolve => video.onloadedmetadata = resolve);
                
                const overlay = document.getElementById(mode === 'register' ? 'overlayReg' : 'overlayRec');
                overlay.width = video.videoWidth;
                overlay.height = video.videoHeight;
                
                btn.textContent = 'Stop Camera';
                btn.className = 'btn btn-danger';
                showMessage(mode === 'register' ? 'msgReg' : 'msgRec', 'Camera started', 'success');
                
                if (mode === 'recognize') {
                    isDetecting = true;
                    detectFaces(video, overlay);
                }
            } catch (error) {
                showMessage(mode === 'register' ? 'msgReg' : 'msgRec', 'Camera error: ' + error.message, 'error');
            }
        }

        // Detect faces continuously
        let lastDetection = 0;
        
        async function detectFaces(video, canvas) {
            if (!isDetecting || !cameraStream) return;

            const now = Date.now();
            if (now - lastDetection < settings.detectionSpeed) {
                requestAnimationFrame(() => detectFaces(video, canvas));
                return;
            }
            lastDetection = now;

            try {
                const detections = await faceapi
                    .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptors()
                    .withAgeAndGender()
                    .withFaceExpressions();

                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                document.getElementById('liveCountRec').textContent = `Faces: ${detections.length}`;

                const currentlyVisible = new Set();

                if (detections.length > 0 && registeredFaces.length > 0) {
                    // Create face matcher with all descriptors for each person
                    const labeledDescriptors = [];
                    registeredFaces.forEach(f => {
                        const descriptors = f.descriptors && f.descriptors.length > 0 
                            ? f.descriptors.map(d => new Float32Array(d))
                            : [new Float32Array(f.descriptor)];
                        labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(f.name, descriptors));
                    });
                    
                    const matcher = new faceapi.FaceMatcher(labeledDescriptors, settings.confidenceThreshold / 100);

                    detections.forEach(detection => {
                        const match = matcher.findBestMatch(detection.descriptor);
                        const box = detection.detection.box;
                        const isUnknown = match.label === 'unknown';
                        
                        const age = Math.round(detection.age);
                        const gender = detection.gender;
                        const genderProb = Math.round(detection.genderProbability * 100);
                        const expressions = detection.expressions;
                        const dominantExpression = Object.keys(expressions).reduce((a, b) => 
                            expressions[a] > expressions[b] ? a : b
                        );
                        const expressionConfidence = Math.round(expressions[dominantExpression] * 100);
                        
                        if (!isUnknown) {
                            currentlyVisible.add(match.label);
                            
                            if (!activeFaces[match.label]) {
                                activeFaces[match.label] = {
                                    firstSeen: now,
                                    lastSeen: now,
                                    detectionCount: 0,
                                    positions: []
                                };
                            }
                            
                            activeFaces[match.label].lastSeen = now;
                            activeFaces[match.label].detectionCount++;
                            
                            if (settings.faceFollowing) {
                                const centerX = box.x + box.width / 2;
                                const centerY = box.y + box.height / 2;
                                activeFaces[match.label].positions.push({ x: centerX, y: centerY, time: now });
                                
                                if (activeFaces[match.label].positions.length > 20) {
                                    activeFaces[match.label].positions.shift();
                                }
                                
                                if (settings.showTrajectory && activeFaces[match.label].positions.length > 1) {
                                    ctx.strokeStyle = '#4CAF50';
                                    ctx.lineWidth = 2;
                                    ctx.beginPath();
                                    activeFaces[match.label].positions.forEach((pos, idx) => {
                                        if (idx === 0) ctx.moveTo(pos.x, pos.y);
                                        else ctx.lineTo(pos.x, pos.y);
                                    });
                                    ctx.stroke();
                                    
                                    activeFaces[match.label].positions.forEach(pos => {
                                        ctx.fillStyle = '#4CAF50';
                                        ctx.beginPath();
                                        ctx.arc(pos.x, pos.y, 3, 0, Math.PI * 2);
                                        ctx.fill();
                                    });
                                }
                            }
                            
                            const confidence = Math.round((1 - match.distance) * 100);
                            
                            if (settings.autoTraining && confidence >= settings.trainingQuality) {
                                if (!trainingData[match.label]) {
                                    trainingData[match.label] = [];
                                }
                                
                                if (trainingData[match.label].length < 50) {
                                    trainingData[match.label].push({
                                        descriptor: Array.from(detection.descriptor),
                                        confidence: confidence,
                                        timestamp: now
                                    });
                                    saveData();
                                }
                            }
                        }
                        
                        if (isUnknown && settings.blurUnknown) {
                            ctx.filter = 'blur(20px)';
                            ctx.drawImage(video, box.x, box.y, box.width, box.height, box.x, box.y, box.width, box.height);
                            ctx.filter = 'none';
                        }
                        
                        let infoLines = 1;
                        if (settings.showConfidence && !isUnknown) infoLines++;
                        if (settings.showAgeGender) infoLines++;
                        if (settings.showExpressions) infoLines++;
                        const boxHeight = 20 + (infoLines * 18);
                        
                        ctx.strokeStyle = isUnknown ? '#f44336' : '#4CAF50';
                        ctx.lineWidth = 3;
                        ctx.strokeRect(box.x, box.y, box.width, box.height);
                        
                        ctx.fillStyle = isUnknown ? '#f44336' : '#4CAF50';
                        ctx.fillRect(box.x, box.y - boxHeight, box.width, boxHeight);
                        
                        ctx.fillStyle = 'white';
                        let yOffset = box.y - boxHeight + 16;
                        
                        ctx.font = 'bold 14px Arial';
                        const name = isUnknown ? 'Unknown' : match.label;
                        ctx.fillText(name, box.x + 5, yOffset);
                        yOffset += 18;
                        
                        if (settings.showConfidence && !isUnknown) {
                            const confidence = Math.round((1 - match.distance) * 100);
                            ctx.font = '12px Arial';
                            ctx.fillText(`Confidence: ${confidence}%`, box.x + 5, yOffset);
                            yOffset += 18;
                        }
                        
                        if (settings.showAgeGender) {
                            ctx.font = '12px Arial';
                            ctx.fillText(`${age}y, ${gender} (${genderProb}%)`, box.x + 5, yOffset);
                            yOffset += 18;
                        }
                        
                        if (settings.showExpressions) {
                            ctx.font = '12px Arial';
                            const expressionEmoji = {
                                'neutral': 'üòê',
                                'happy': 'üòä',
                                'sad': 'üò¢',
                                'angry': 'üò†',
                                'fearful': 'üò®',
                                'disgusted': 'ü§¢',
                                'surprised': 'üò≤'
                            };
                            ctx.fillText(`${expressionEmoji[dominantExpression] || ''} ${dominantExpression} (${expressionConfidence}%)`, box.x + 5, yOffset);
                        }
                        
                        if (!isUnknown) {
                            const shouldLog = !lastLogged[match.label] || (now - lastLogged[match.label] > settings.attendanceCooldown);
                            const confidence = Math.round((1 - match.distance) * 100);
                            
                            if (shouldLog) {
                                logRecognition(match.label, confidence, isUnknown, age, gender, dominantExpression);
                                lastLogged[match.label] = now;
                                
                                if (settings.anomalyDetection) {
                                    detectAnomalies(match.label, confidence, now);
                                }
                            }
                        }
                        
                        if (!isUnknown && !lastRecognized[match.label]) {
                            speak(`Hello ${match.label}`);
                            lastRecognized[match.label] = now;
                        }
                        
                        if (!isUnknown && activeFaces[match.label]) {
                            clearTimeout(activeFaces[match.label].voiceTimeout);
                            activeFaces[match.label].voiceTimeout = setTimeout(() => {
                                delete lastRecognized[match.label];
                            }, 30000);
                        }
                        
                        if (isUnknown && settings.alertUnknown) {
                            if (!lastRecognized['unknown'] || (now - lastRecognized['unknown'] > 10000)) {
                                alert('Unknown face detected!');
                                lastRecognized['unknown'] = now;
                            }
                        }
                        
                        if (settings.alertSpecific && settings.alertPerson && match.label === settings.alertPerson) {
                            if (!lastRecognized['alert_' + match.label] || (now - lastRecognized['alert_' + match.label] > 10000)) {
                                alert(`${match.label} detected!`);
                                lastRecognized['alert_' + match.label] = now;
                            }
                        }
                    });
                } else if (detections.length > 0) {
                    detections.forEach(detection => {
                        const box = detection.detection.box;
                        const age = Math.round(detection.age);
                        const gender = detection.gender;
                        
                        const boxHeight = settings.showAgeGender ? 45 : 25;
                        
                        ctx.strokeStyle = '#FF9800';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(box.x, box.y, box.width, box.height);
                        
                        ctx.fillStyle = '#FF9800';
                        ctx.fillRect(box.x, box.y - boxHeight, box.width, boxHeight);
                        
                        ctx.fillStyle = 'white';
                        ctx.font = '14px Arial';
                        ctx.fillText('No faces registered', box.x + 5, box.y - boxHeight + 16);
                        
                        if (settings.showAgeGender) {
                            ctx.font = '12px Arial';
                            ctx.fillText(`${age}y, ${gender}`, box.x + 5, box.y - boxHeight + 34);
                        }
                    });
                }

                Object.keys(activeFaces).forEach(name => {
                    if (!currentlyVisible.has(name) && (now - activeFaces[name].lastSeen > 3000)) {
                        delete activeFaces[name];
                    }
                });

            } catch (error) {
                console.error('Detection error:', error);
            }

            requestAnimationFrame(() => detectFaces(video, canvas));
        }

        // Log recognition
        function logRecognition(name, confidence, isUnknown, age, gender, expression) {
            const timestamp = new Date().toLocaleString();
            const date = new Date().toLocaleDateString();
            
            recognitionHistory.push({
                name: isUnknown ? 'Unknown Person' : name,
                confidence: confidence,
                timestamp: timestamp,
                isUnknown: isUnknown,
                age: age || 'N/A',
                gender: gender || 'N/A',
                expression: expression || 'N/A'
            });
            
            if (!isUnknown) {
                attendanceLog.push({
                    name: name,
                    confidence: confidence,
                    timestamp: timestamp,
                    date: date,
                    age: age || 'N/A',
                    gender: gender || 'N/A',
                    expression: expression || 'N/A'
                });
            }
            
            saveData();
        }

        // Capture from camera
        async function captureFromCamera() {
            const video = document.getElementById('videoReg');
            const canvas = document.getElementById('canvasReg');
            const name = document.getElementById('nameInput').value.trim();
            
            if (!name) {
                showMessage('msgReg', 'Please enter a name', 'error');
                return;
            }
            
            if (!cameraStream) {
                showMessage('msgReg', 'Please start camera first', 'error');
                return;
            }
            
            try {
                showMessage('msgReg', 'Detecting face...', 'info');
                
                const detection = await faceapi
                    .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptor();
                
                if (!detection) {
                    showMessage('msgReg', 'No face detected', 'error');
                    return;
                }
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const image = canvas.toDataURL('image/jpeg', 0.8);
                
                // Check if person already exists
                const existingPerson = registeredFaces.find(f => f.name.toLowerCase() === name.toLowerCase());
                
                if (existingPerson) {
                    // Add descriptor to existing profile
                    if (!existingPerson.descriptors) {
                        existingPerson.descriptors = [existingPerson.descriptor];
                    }
                    existingPerson.descriptors.push(Array.from(detection.descriptor));
                    existingPerson.imageCount = existingPerson.descriptors.length;
                    existingPerson.time = new Date().toLocaleString();
                    showMessage('msgReg', `Added photo ${existingPerson.imageCount} for ${name}!`, 'success');
                } else {
                    // Create new profile
                    registeredFaces.push({
                        id: Date.now(),
                        name: name,
                        image: image,
                        descriptor: Array.from(detection.descriptor),
                        descriptors: [Array.from(detection.descriptor)],
                        imageCount: 1,
                        time: new Date().toLocaleString()
                    });
                    showMessage('msgReg', `Registered ${name} successfully!`, 'success');
                }
                
                document.getElementById('nameInput').value = '';
                saveData();
                updateUI();
            } catch (error) {
                showMessage('msgReg', 'Error: ' + error.message, 'error');
            }
        }

        // Upload photo
        async function uploadPhoto(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const name = document.getElementById('nameInput').value.trim();
            if (!name) {
                showMessage('msgReg', 'Please enter a name', 'error');
                document.getElementById('nameInput').focus();
                return;
            }
            
            try {
                showMessage('msgReg', 'Processing image...', 'info');
                const img = await loadImage(file);
                
                const detection = await faceapi
                    .detectSingleFace(img, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptor();
                
                if (!detection) {
                    showMessage('msgReg', 'No face detected in image', 'error');
                    return;
                }
                
                const smallImg = await resizeImage(img, 200);
                
                // Check if person already exists
                const existingPerson = registeredFaces.find(f => f.name.toLowerCase() === name.toLowerCase());
                
                if (existingPerson) {
                    // Add descriptor to existing profile
                    if (!existingPerson.descriptors) {
                        existingPerson.descriptors = [existingPerson.descriptor];
                    }
                    existingPerson.descriptors.push(Array.from(detection.descriptor));
                    existingPerson.imageCount = existingPerson.descriptors.length;
                    existingPerson.time = new Date().toLocaleString();
                    showMessage('msgReg', `Added photo ${existingPerson.imageCount} for ${name}!`, 'success');
                } else {
                    // Create new profile
                    registeredFaces.push({
                        id: Date.now(),
                        name: name,
                        image: smallImg,
                        descriptor: Array.from(detection.descriptor),
                        descriptors: [Array.from(detection.descriptor)],
                        imageCount: 1,
                        time: new Date().toLocaleString()
                    });
                    showMessage('msgReg', `Registered ${name} successfully!`, 'success');
                }
                
                document.getElementById('nameInput').value = '';
                event.target.value = '';
                saveData();
                updateUI();
            } catch (error) {
                showMessage('msgReg', 'Error: ' + error.message, 'error');
            }
        }

        // Import photos (PNG/HEIF)
        async function importPhotos(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            showMessage('msgReg', `Processing ${files.length} photos...`, 'info');
            
            let successCount = 0;
            for (let i = 0; i < files.length; i++) {
                try {
                    const img = await loadImage(files[i]);
                    const detection = await faceapi
                        .detectSingleFace(img, new faceapi.TinyFaceDetectorOptions())
                        .withFaceLandmarks()
                        .withFaceDescriptor();
                    
                    if (detection) {
                        const fileName = files[i].name.replace(/\.[^/.]+$/, "");
                        const smallImg = await resizeImage(img, 200);
                        
                        registeredFaces.push({
                            id: Date.now() + i,
                            name: fileName,
                            image: smallImg,
                            descriptor: Array.from(detection.descriptor),
                            time: new Date().toLocaleString()
                        });
                        successCount++;
                    }
                } catch (error) {
                    console.error(`Error processing ${files[i].name}:`, error);
                }
            }
            
            event.target.value = '';
            showMessage('msgReg', `Imported ${successCount} of ${files.length} photos`, 'success');
            saveData();
            updateUI();
        }

        // Batch register
        async function batchRegister(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            showMessage('msgReg', `Processing ${files.length} images...`, 'info');
            
            let successCount = 0;
            for (let i = 0; i < files.length; i++) {
                try {
                    const img = await loadImage(files[i]);
                    const detection = await faceapi
                        .detectSingleFace(img, new faceapi.TinyFaceDetectorOptions())
                        .withFaceLandmarks()
                        .withFaceDescriptor();
                    
                    if (detection) {
                        const fileName = files[i].name.replace(/\.[^/.]+$/, "");
                        const smallImg = await resizeImage(img, 200);
                        
                        registeredFaces.push({
                            id: Date.now() + i,
                            name: fileName,
                            image: smallImg,
                            descriptor: Array.from(detection.descriptor),
                            time: new Date().toLocaleString()
                        });
                        successCount++;
                    }
                } catch (error) {
                    console.error(`Error processing ${files[i].name}:`, error);
                }
            }
            
            event.target.value = '';
            showMessage('msgReg', `Successfully registered ${successCount} of ${files.length} faces`, 'success');
            saveData();
            updateUI();
        }

        // Load image
        function loadImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        // Resize image
        function resizeImage(img, maxSize) {
            return new Promise(resolve => {
                const canvas = document.createElement('canvas');
                let w = img.width, h = img.height;
                
                if (w > h) {
                    if (w > maxSize) { h *= maxSize / w; w = maxSize; }
                } else {
                    if (h > maxSize) { w *= maxSize / h; h = maxSize; }
                }
                
                canvas.width = w;
                canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                resolve(canvas.toDataURL('image/jpeg', 0.8));
            });
        }

        // Capture snapshot
        function captureSnapshot() {
            const video = document.getElementById('videoRec');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            snapshots.push({
                image: canvas.toDataURL('image/jpeg', 0.8),
                timestamp: new Date().toLocaleString()
            });
            
            saveData();
            updateSnapshotGallery();
            showMessage('msgRec', 'Snapshot captured!', 'success');
        }

        // Delete snapshot
        function deleteSnapshot(index) {
            snapshots.splice(index, 1);
            saveData();
            updateSnapshotGallery();
        }

        // Clear snapshots
        function clearSnapshots() {
            if (snapshots.length === 0) return;
            if (confirm(`Delete all ${snapshots.length} snapshots?`)) {
                snapshots = [];
                saveData();
                updateSnapshotGallery();
            }
        }

        // Delete face
        function deleteFace(id) {
            registeredFaces = registeredFaces.filter(f => f.id !== id);
            saveData();
            updateUI();
            showMessage('msgReg', 'Face deleted', 'info');
        }

        // Clear all faces
        function clearAll() {
            if (registeredFaces.length === 0) return;
            if (confirm(`Delete all ${registeredFaces.length} registered faces?`)) {
                registeredFaces = [];
                saveData();
                updateUI();
                showMessage('msgReg', 'All faces cleared', 'info');
            }
        }

        // Clear history
        function clearHistory() {
            if (recognitionHistory.length === 0) return;
            if (confirm('Clear all recognition history?')) {
                recognitionHistory = [];
                saveData();
                updateHistory();
            }
        }

        // Export data as JSON
        function exportData() {
            const dataStr = JSON.stringify(registeredFaces, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `face_data_${Date.now()}.json`;
            a.click();
        }

        // Import data
        function importData() {
            document.getElementById('importInput').click();
        }

        // Handle import
        async function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const imported = JSON.parse(text);
                
                if (Array.isArray(imported) && imported.length > 0) {
                    const proceed = confirm(`Import ${imported.length} faces? This will add to existing data.`);
                    if (proceed) {
                        registeredFaces.push(...imported);
                        saveData();
                        updateUI();
                        showMessage('msgReg', `Imported ${imported.length} faces`, 'success');
                    }
                }
            } catch (error) {
                showMessage('msgReg', 'Invalid file format', 'error');
            }
            event.target.value = '';
        }

        // Export attendance CSV
        function exportAttendance() {
            if (attendanceLog.length === 0) {
                alert('No attendance data to export');
                return;
            }
            
            const csv = 'Name,Confidence,Age,Gender,Expression,Timestamp,Date\n' + 
                attendanceLog.map(log => 
                    `"${log.name}",${log.confidence},"${log.age || 'N/A'}","${log.gender || 'N/A'}","${log.expression || 'N/A'}","${log.timestamp}","${log.date}"`
                ).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_${Date.now()}.csv`;
            a.click();
        }

        // Compare faces
        async function compareFaces() {
            if (!compareImage1 || !compareImage2) {
                alert('Please upload both images');
                return;
            }
            
            try {
                const resultDiv = document.getElementById('compareResult');
                resultDiv.innerHTML = '<p style="text-align:center;color:var(--text-secondary);">Analyzing...</p>';
                
                const detection1 = await faceapi
                    .detectSingleFace(compareImage1, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptor();
                
                const detection2 = await faceapi
                    .detectSingleFace(compareImage2, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptor();
                
                if (!detection1 || !detection2) {
                    resultDiv.innerHTML = '<div class="card" style="background:var(--bg-primary);"><p style="color:var(--danger);text-align:center;">Could not detect faces in one or both images</p></div>';
                    return;
                }
                
                const distance = faceapi.euclideanDistance(detection1.descriptor, detection2.descriptor);
                const similarity = Math.round((1 - distance) * 100);
                const match = distance < 0.6;
                
                resultDiv.innerHTML = `
                    <div class="card" style="background:var(--bg-primary);">
                        <h3 style="text-align:center;margin-bottom:15px;">Comparison Result</h3>
                        <div class="stat-card">
                            <div class="stat-value" style="color:${match ? 'var(--success)' : 'var(--danger)'}">${similarity}%</div>
                            <div class="stat-label">Similarity Score</div>
                        </div>
                        <p style="text-align:center;margin-top:15px;font-size:18px;font-weight:bold;color:${match ? 'var(--success)' : 'var(--danger)'}">
                            ${match ? 'MATCH - Same person' : 'NO MATCH - Different people'}
                        </p>
                        <p style="text-align:center;margin-top:10px;color:var(--text-secondary);font-size:14px;">
                            Distance: ${distance.toFixed(4)} (Threshold: 0.6)
                        </p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('compareResult').innerHTML = 
                    '<div class="card" style="background:var(--bg-primary);"><p style="color:var(--danger);text-align:center;">Error: ' + error.message + '</p></div>';
            }
        }

        // Handle compare image uploads
        function handleCompareUpload(inputId, previewId, imageNum) {
            const input = document.getElementById(inputId);
            input.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const img = await loadImage(file);
                if (imageNum === 1) compareImage1 = img;
                else compareImage2 = img;
                
                const preview = document.getElementById(previewId);
                preview.innerHTML = `<img src="${img.src}" style="width:100%;height:100%;object-fit:cover;">`;
            });
        }

        // Backup all data
        function backupData() {
            const backup = {
                faces: registeredFaces,
                history: recognitionHistory,
                attendance: attendanceLog,
                snapshots: snapshots,
                settings: settings,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `full_backup_${Date.now()}.json`;
            a.click();
            
            alert('Full backup downloaded!');
        }

        // Restore data
        function restoreData() {
            document.getElementById('restoreInput').click();
        }

        // Handle restore
        async function handleRestore(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const backup = JSON.parse(text);
                
                if (confirm('Restore from backup? This will replace all current data.')) {
                    registeredFaces = backup.faces || [];
                    recognitionHistory = backup.history || [];
                    attendanceLog = backup.attendance || [];
                    snapshots = backup.snapshots || [];
                    if (backup.settings) {
                        settings = { ...settings, ...backup.settings };
                        saveSettings();
                        applySettings();
                    }
                    saveData();
                    updateUI();
                    alert('Data restored successfully!');
                }
            } catch (error) {
                alert('Invalid backup file');
            }
            event.target.value = '';
        }

        // Setup event listeners
        function setupEventListeners() {
            // Register tab
            document.getElementById('startCamReg').addEventListener('click', () => startCamera('videoReg', 'register'));
            document.getElementById('captureBtn').addEventListener('click', captureFromCamera);
            document.getElementById('uploadBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('fileInput').addEventListener('change', uploadPhoto);
            document.getElementById('batchRegisterBtn').addEventListener('click', () => document.getElementById('batchFileInput').click());
            document.getElementById('batchFileInput').addEventListener('change', batchRegister);
            document.getElementById('importPhotosBtn').addEventListener('click', () => document.getElementById('photoImportInput').click());
            document.getElementById('photoImportInput').addEventListener('change', importPhotos);
            document.getElementById('searchInput').addEventListener('input', updateFaceList);
            document.getElementById('importInput').addEventListener('change', handleImport);
            
            // Recognize tab
            document.getElementById('startCamRec').addEventListener('click', () => startCamera('videoRec', 'recognize'));
            document.getElementById('captureSnapshot').addEventListener('click', captureSnapshot);
            
            // Recognition options - save settings on change
            document.getElementById('blurUnknown').addEventListener('change', (e) => {
                settings.blurUnknown = e.target.checked;
                saveSettings();
            });
            document.getElementById('alertUnknown').addEventListener('change', (e) => {
                settings.alertUnknown = e.target.checked;
                saveSettings();
            });
            document.getElementById('showAgeGender').addEventListener('change', (e) => {
                settings.showAgeGender = e.target.checked;
                saveSettings();
            });
            document.getElementById('showExpressions').addEventListener('change', (e) => {
                settings.showExpressions = e.target.checked;
                saveSettings();
            });
            document.getElementById('showConfidence').addEventListener('change', (e) => {
                settings.showConfidence = e.target.checked;
                saveSettings();
            });
            
            // Settings tab
            document.getElementById('thresholdSlider').addEventListener('input', (e) => {
                settings.confidenceThreshold = parseInt(e.target.value);
                document.getElementById('thresholdValue').textContent = e.target.value + '%';
                saveSettings();
            });
            
            document.getElementById('speedSlider').addEventListener('input', (e) => {
                settings.detectionSpeed = parseInt(e.target.value);
                const speed = settings.detectionSpeed <= 200 ? 'Fast' : settings.detectionSpeed <= 500 ? 'Medium' : 'Slow';
                document.getElementById('speedValue').textContent = `${speed} (${settings.detectionSpeed}ms)`;
                saveSettings();
            });
            
            document.getElementById('cooldownSlider').addEventListener('input', (e) => {
                settings.attendanceCooldown = parseInt(e.target.value);
                const minutes = Math.round(settings.attendanceCooldown / 60000);
                document.getElementById('cooldownValue').textContent = `${minutes} minute${minutes !== 1 ? 's' : ''}`;
                saveSettings();
            });
            
            document.getElementById('alertSpecific').addEventListener('change', (e) => {
                settings.alertSpecific = e.target.checked;
                document.getElementById('alertPerson').disabled = !e.target.checked;
                saveSettings();
            });
            
            document.getElementById('alertPerson').addEventListener('change', (e) => {
                settings.alertPerson = e.target.value;
                saveSettings();
            });
            
            document.getElementById('restoreInput').addEventListener('change', handleRestore);
            
            // Compare tab
            handleCompareUpload('compare1', 'preview1', 1);
            handleCompareUpload('compare2', 'preview2', 2);
            
            // AI Features - save settings on change
            document.getElementById('autoTraining').addEventListener('change', (e) => {
                settings.autoTraining = e.target.checked;
                saveSettings();
            });
            
            document.getElementById('trainingQualitySlider').addEventListener('input', (e) => {
                settings.trainingQuality = parseInt(e.target.value);
                document.getElementById('trainingQualityValue').textContent = e.target.value + '%';
                saveSettings();
            });
            
            document.getElementById('faceFollowing').addEventListener('change', (e) => {
                settings.faceFollowing = e.target.checked;
                saveSettings();
            });
            
            document.getElementById('showTrajectory').addEventListener('change', (e) => {
                settings.showTrajectory = e.target.checked;
                saveSettings();
            });
            
            document.getElementById('anomalyDetection').addEventListener('change', (e) => {
                settings.anomalyDetection = e.target.checked;
                saveSettings();
            });
            
            document.getElementById('detectMultipleUnknown').addEventListener('change', (e) => {
                settings.detectMultipleUnknown = e.target.checked;
                saveSettings();
            });
            
            document.getElementById('detectUnusualTimes').addEventListener('change', (e) => {
                settings.detectUnusualTimes = e.target.checked;
                saveSettings();
            });
            
            document.getElementById('detectRapidEntry').addEventListener('change', (e) => {
                settings.detectRapidEntry = e.target.checked;
                saveSettings();
            });
            
            document.getElementById('detectLowConfidence').addEventListener('change', (e) => {
                settings.detectLowConfidence = e.target.checked;
                saveSettings();
            });
        }
        
        // AI Features Functions
        
        // Update AI Features tab
        function updateAIFeatures() {
            let totalSamples = 0;
            Object.values(trainingData).forEach(samples => {
                totalSamples += samples.length;
            });
            document.getElementById('trainingCount').textContent = totalSamples;
            
            document.getElementById('trackedFaces').textContent = Object.keys(activeFaces).length;
            
            updateAnomalyLog();
        }
        
        // Apply training data
        function applyTraining() {
            if (Object.keys(trainingData).length === 0) {
                alert('No training data available');
                return;
            }
            
            let improvedCount = 0;
            Object.keys(trainingData).forEach(name => {
                const face = registeredFaces.find(f => f.name === name);
                if (face && trainingData[name].length > 0) {
                    const avgDescriptor = new Array(128).fill(0);
                    trainingData[name].forEach(sample => {
                        sample.descriptor.forEach((val, idx) => {
                            avgDescriptor[idx] += val;
                        });
                    });
                    
                    avgDescriptor.forEach((val, idx) => {
                        avgDescriptor[idx] /= trainingData[name].length;
                    });
                    
                    face.descriptor = avgDescriptor;
                    improvedCount++;
                }
            });
            
            saveData();
            alert(`Improved ${improvedCount} face registrations with training data`);
        }
        
        // Clear training data
        function clearTraining() {
            if (confirm('Clear all training data?')) {
                trainingData = {};
                saveData();
                updateAIFeatures();
            }
        }
        
        // Detect anomalies
        function detectAnomalies(name, confidence, timestamp) {
            const hour = new Date(timestamp).getHours();
            
            if (settings.detectUnusualTimes) {
                if (hour < 6 || hour > 22) {
                    addAnomaly('Unusual Time Access', `${name} detected at ${new Date(timestamp).toLocaleTimeString()}`);
                }
            }
            
            if (settings.detectLowConfidence) {
                if (confidence < 70) {
                    addAnomaly('Low Confidence Detection', `${name} detected with ${confidence}% confidence`);
                }
            }
            
            if (settings.detectRapidEntry) {
                if (activeFaces[name]) {
                    const duration = timestamp - activeFaces[name].firstSeen;
                    if (duration < 5000) {
                        addAnomaly('Rapid Entry/Exit', `${name} stayed for only ${Math.round(duration/1000)} seconds`);
                    }
                }
            }
            
            if (settings.detectMultipleUnknown) {
                const recentUnknown = recognitionHistory.filter(h => 
                    h.isUnknown && (Date.now() - new Date(h.timestamp).getTime() < 60000)
                ).length;
                
                if (recentUnknown >= 3) {
                    addAnomaly('Multiple Unknown Faces', `${recentUnknown} unknown faces detected in last minute`);
                }
            }
        }
        
        // Add anomaly
        function addAnomaly(type, description) {
            const anomaly = {
                type: type,
                description: description,
                timestamp: new Date().toLocaleString()
            };
            
            const isDuplicate = anomalies.some(a => 
                a.type === type && 
                a.description === description &&
                (Date.now() - new Date(a.timestamp).getTime() < 300000)
            );
            
            if (!isDuplicate) {
                anomalies.push(anomaly);
                saveData();
                updateAnomalyLog();
            }
        }
        
        // Update anomaly log
        function updateAnomalyLog() {
            const logDiv = document.getElementById('anomalyLog');
            if (anomalies.length === 0) {
                logDiv.innerHTML = '<p style="color:var(--text-secondary);">No anomalies detected</p>';
                return;
            }
            
            logDiv.innerHTML = anomalies.slice().reverse().slice(0, 10).map(a => `
                <div style="margin-bottom:8px;padding:8px;background:var(--bg-secondary);border-left:3px solid var(--warning);border-radius:4px;">
                    <strong>${a.type}</strong><br>
                    <span style="font-size:11px;">${a.description}</span><br>
                    <span style="font-size:10px;color:var(--text-secondary);">${a.timestamp}</span>
                </div>
            `).join('');
        }
        
        // Clear anomalies
        function clearAnomalies() {
            if (confirm('Clear all anomalies?')) {
                anomalies = [];
                saveData();
                updateAnomalyLog();
            }
        }
        
        // Scan for duplicate faces
        async function scanDuplicates() {
            const resultsDiv = document.getElementById('duplicateResults');
            resultsDiv.innerHTML = '<p style="text-align:center;color:var(--text-secondary);">Scanning for duplicates...</p>';
            
            const duplicateGroups = [];
            const checked = new Set();
            
            for (let i = 0; i < registeredFaces.length; i++) {
                if (checked.has(i)) continue;
                
                const group = [i];
                const desc1 = new Float32Array(registeredFaces[i].descriptor);
                
                for (let j = i + 1; j < registeredFaces.length; j++) {
                    if (checked.has(j)) continue;
                    
                    const desc2 = new Float32Array(registeredFaces[j].descriptor);
                    const distance = faceapi.euclideanDistance(desc1, desc2);
                    
                    if (distance < 0.4) {
                        group.push(j);
                        checked.add(j);
                    }
                }
                
                if (group.length > 1) {
                    duplicateGroups.push(group);
                }
                checked.add(i);
            }
            
            if (duplicateGroups.length === 0) {
                resultsDiv.innerHTML = '<p style="text-align:center;color:var(--success);">No duplicates found!</p>';
                return;
            }
            
            resultsDiv.innerHTML = '<h4 style="margin-bottom:10px;">Found ' + duplicateGroups.length + ' duplicate groups:</h4>';
            
            duplicateGroups.forEach((group, gIdx) => {
                const groupDiv = document.createElement('div');
                groupDiv.style.cssText = 'background:var(--bg-primary);padding:15px;border-radius:4px;margin-bottom:15px;';
                
                let html = '<p style="font-weight:bold;margin-bottom:10px;">Group ' + (gIdx + 1) + ':</p>';
                html += '<div style="display:flex;gap:10px;flex-wrap:wrap;">';
                
                group.forEach(idx => {
                    const face = registeredFaces[idx];
                    html += `
                        <div style="text-align:center;">
                            <img src="${face.image}" style="width:80px;height:80px;object-fit:cover;border-radius:4px;border:2px solid var(--border-color);">
                            <div style="font-size:12px;margin-top:5px;">${face.name}</div>
                            <button class="btn btn-danger" onclick="deleteFace(${face.id})" style="padding:4px 8px;font-size:11px;margin-top:5px;">Delete</button>
                        </div>
                    `;
                });
                
                html += '</div>';
                groupDiv.innerHTML = html;
                resultsDiv.appendChild(groupDiv);
            });
        }

        // Start the application
        init();
    </script>
</body>
</html>
